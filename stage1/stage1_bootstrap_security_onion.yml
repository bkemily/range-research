---
# ============================================================================
# Stage 1: Deploy Security Onion VM
# ============================================================================
# Purpose: Import and configure Security Onion VM from OVF template
#
# This playbook:
#   1. Verifies required bridges exist (from Stage 0)
#   2. Imports Security Onion OVF template
#   3. Configures VM hardware (SCSI, BIOS, boot)
#   4. Assigns network interfaces (dynamically based on student groups)
#   5. Starts the VM
#   6. Verifies VM is running
#
# Prerequisites:
#   - Stage 0 completed (all bridges created)
#   - Security Onion OVF template available on NFS storage
#   - SSH access to Proxmox host
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml stage1/stage1_bootstrap_security_onion.yml
#   ansible-playbook -i inventory/hosts.yml stage1/stage1_bootstrap_security_onion.yml -e auto_confirm=true
#   ansible-playbook -i inventory/hosts.yml stage1/stage1_bootstrap_security_onion.yml -e max_student_groups=5
#
# Variables from inventory/group_vars/all.yml:
#   - proxmox_host, proxmox_user, proxmox_node
#   - security_onion.* (vmid, name, template, storage, etc.)
#   - bridges.* (spark_wan, instructor_lan)
#   - max_student_groups
#
# Author: Emily Miller
# Last Updated: December 1, 2025
# ============================================================================

- name: Stage 1 - Deploy Security Onion VM
  hosts: localhost
  connection: local
  gather_facts: yes

  tasks:
  # ========================================
  # Stage 1.1: Display Information
  # ========================================

  - name: Display stage information
    ansible.builtin.debug:
      msg: |
        ========================================
        STAGE 1: Security Onion VM Deployment
        ========================================

        This playbook will:
          1. Verify all required bridges exist
          2. Import Security Onion OVF template
          3. Configure VM hardware
          4. Assign {{ 2 + (max_student_groups * 2) }} network interfaces
          5. Start the VM
          6. Verify VM is running

        VM Configuration:
          - VM ID: {{ security_onion.vmid }}
          - Name: {{ security_onion.name }}
          - Template: {{ security_onion.template }}
          - Storage: {{ security_onion.storage }}
          - Management Bridge: {{ security_onion.management_bridge }}

        Network Interfaces:
          - net0: {{ security_onion.management_bridge }} (Management)
          - net1: {{ bridges.spark_wan }} (Monitor Spark WAN)
          - net2+: Student group monitoring ({{ max_student_groups }} groups)

        Total Interfaces: {{ 2 + (max_student_groups * 2) }}

        ========================================

  # ========================================
  # Stage 1.2: Pre-deployment Validation
  # ========================================

  - name: Test SSH connection to Proxmox
    ansible.builtin.command:
      cmd: ssh -o ConnectTimeout=5 {{ proxmox_user }}@{{ proxmox_host }} "echo 'Connection successful'"
    register: ssh_test
    changed_when: false
    failed_when: ssh_test.rc != 0

  - name: Display connection status
    ansible.builtin.debug:
      msg: "✓ SSH connection to Proxmox successful"
    when: ssh_test.rc == 0

  - name: Generate student group bridges list
    ansible.builtin.set_fact:
      student_bridges: "{{ student_bridges | default([]) + [bridge_wan, bridge_lan] }}"
    vars:
      bridge_wan: "vmbr255{{ '%03d' | format(item) }}"
      bridge_lan: "vmbr{{ '%03d' | format(item) }}000"
    loop: "{{ range(1, max_student_groups + 1) | list }}"

  - name: Combine infrastructure and student bridges
    ansible.builtin.set_fact:
      required_bridges: "{{ ['vmbr51', 'vmbr255000'] + student_bridges }}"

  - name: Display bridges to verify
    ansible.builtin.debug:
      msg: "Verifying {{ required_bridges | length }} bridges"

  - name: Display infrastructure bridges
    ansible.builtin.debug:
      msg: |
        Infrastructure:
          - vmbr51 (Spark WAN)
          - vmbr255000 (Instructor LAN)

  - name: Display student group bridges
    ansible.builtin.debug:
      msg: |
        Group {{ item }}:
          - vmbr255{{ (item | string).zfill(3) }} (WAN)
          - vmbr{{ (item | string).zfill(3) }}000 (LAN)
    loop: "{{ range(1, max_student_groups + 1) | list }}"

  - name: Verify required bridges exist
    ansible.builtin.command:
      cmd: ssh {{ proxmox_user }}@{{ proxmox_host }} "ip link show {{ item }}"
    loop: "{{ required_bridges }}"
    register: bridge_check
    changed_when: false
    failed_when: bridge_check.rc != 0

  - name: Display bridge verification
    ansible.builtin.debug:
      msg: "✓ All {{ required_bridges | length }} required bridges verified on Proxmox"

  - name: Check if VM already exists
    ansible.builtin.command:
      cmd: ssh {{ proxmox_user }}@{{ proxmox_host }} "qm status {{ security_onion.vmid }}"
    register: vm_exists
    changed_when: false
    failed_when: false

  - name: Stop if VM already exists
    ansible.builtin.fail:
      msg: |
        VM {{ security_onion.vmid }} already exists!
        
        Current status: {{ vm_exists.stdout }}
        
        If you want to recreate it, first destroy the existing VM:
          ssh {{ proxmox_user }}@{{ proxmox_host }} "qm stop {{ security_onion.vmid }} && qm destroy {{ security_onion.vmid }}"
    when: vm_exists.rc == 0

  - name: Check if OVF template exists
    ansible.builtin.command:
      cmd: ssh {{ proxmox_user }}@{{ proxmox_host }} "test -f {{ security_onion.template }}"
    register: template_check
    changed_when: false
    failed_when: template_check.rc != 0

  - name: Display template verification
    ansible.builtin.debug:
      msg: "✓ Security Onion OVF template found: {{ security_onion.template }}"

  # ========================================
  # Stage 1.3: Import OVF Template
  # ========================================

  - name: Import Security Onion OVF
    ansible.builtin.command:
      cmd: >
        ssh {{ proxmox_user }}@{{ proxmox_host }}
        "qm importovf {{ security_onion.vmid }} {{ security_onion.template }} {{ security_onion.storage }}"
    register: import_result
    changed_when: true

  - name: Display import status
    ansible.builtin.debug:
      msg: "✓ Security Onion OVF imported (VM ID: {{ security_onion.vmid }})"

  # ========================================
  # Stage 1.4: Configure VM Hardware
  # ========================================

  - name: Configure SCSI controller and disk
    ansible.builtin.command:
      cmd: >
        ssh {{ proxmox_user }}@{{ proxmox_host }}
        "qm set {{ security_onion.vmid }} 
        --scsihw {{ security_onion.scsihw }} 
        --scsi0 {{ security_onion.storage }}:vm-{{ security_onion.vmid }}-disk-0"
    register: scsi_result
    changed_when: true

  - name: Set BIOS and boot order
    ansible.builtin.command:
      cmd: >
        ssh {{ proxmox_user }}@{{ proxmox_host }}
        "qm set {{ security_onion.vmid }} 
        --bios {{ security_onion.bios }} 
        --boot order={{ security_onion.boot_order }}"
    register: bios_result
    changed_when: true

  - name: Set VM name
    ansible.builtin.command:
      cmd: >
        ssh {{ proxmox_user }}@{{ proxmox_host }}
        "qm set {{ security_onion.vmid }} --name {{ security_onion.name }}"
    register: name_result
    changed_when: true

  - name: Display hardware configuration status
    ansible.builtin.debug:
      msg: "✓ VM hardware configured (SCSI, BIOS, boot order, name)"

  # ========================================
  # Stage 1.5: Assign Network Interfaces
  # ========================================

  - name: Assign management interface (net0)
    ansible.builtin.command:
      cmd: >
        ssh {{ proxmox_user }}@{{ proxmox_host }}
        "qm set {{ security_onion.vmid }} 
        --net0 virtio,bridge={{ security_onion.management_bridge }}"
    register: net0_result
    changed_when: true

  - name: Display management interface assignment
    ansible.builtin.debug:
      msg: "✓ net0 assigned: {{ security_onion.management_bridge }} (Management)"

  - name: Assign Spark WAN monitoring interface (net1)
    ansible.builtin.command:
      cmd: >
        ssh {{ proxmox_user }}@{{ proxmox_host }}
        "qm set {{ security_onion.vmid }} 
        --net1 virtio,bridge={{ bridges.spark_wan }}"
    register: net1_result
    changed_when: true

  - name: Display Spark WAN interface assignment
    ansible.builtin.debug:
      msg: "✓ net1 assigned: {{ bridges.spark_wan }} (Monitor Spark WAN)"

  - name: Generate student group monitoring interface assignments
    ansible.builtin.set_fact:
      monitoring_interfaces: "{{ monitoring_interfaces | default([]) + [wan_interface, lan_interface] }}"
    vars:
      wan_interface:
        net_id: "net{{ 2 + ((item - 1) * 2) }}"
        bridge: "vmbr255{{ '%03d' | format(item) }}"
        description: "Group {{ item }} WAN"
      lan_interface:
        net_id: "net{{ 2 + ((item - 1) * 2) + 1 }}"
        bridge: "vmbr{{ '%03d' | format(item) }}000"
        description: "Group {{ item }} LAN"
    loop: "{{ range(1, max_student_groups + 1) | list }}"

  - name: Assign student group monitoring interfaces
    ansible.builtin.command:
      cmd: >
        ssh {{ proxmox_user }}@{{ proxmox_host }}
        "qm set {{ security_onion.vmid }} 
        --{{ item.net_id }} virtio,bridge={{ item.bridge }}"
    loop: "{{ monitoring_interfaces }}"
    register: monitoring_result
    changed_when: true

  - name: Display student monitoring interface assignments
    ansible.builtin.debug:
      msg: "✓ {{ item.net_id }} assigned: {{ item.bridge }} ({{ item.description }})"
    loop: "{{ monitoring_interfaces }}"

  - name: Display network configuration summary
    ansible.builtin.debug:
      msg: |
        ========================================
        Network Interfaces Configured
        ========================================
        Total: {{ 2 + (max_student_groups * 2) }} interfaces
        
        Infrastructure:
          - net0: {{ security_onion.management_bridge }} (Management)
          - net1: {{ bridges.spark_wan }} (Spark WAN)
        
        Student Group Monitoring:
        {% for interface in monitoring_interfaces %}
          - {{ interface.net_id }}: {{ interface.bridge }} ({{ interface.description }})
        {% endfor %}
        ========================================