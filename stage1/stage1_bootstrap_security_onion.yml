---
# ============================================================================
# Stage 1: Deploy Security Onion VM
# ============================================================================
# Purpose: Import and configure Security Onion VM from OVF template
#
# This playbook:
#   1. Verifies required bridges exist (from Stage 0)
#   2. Imports Security Onion OVF template
#   3. Configures VM hardware (SCSI, BIOS, boot)
#   4. Assigns network interfaces (dynamically based on student groups)
#   5. Starts the VM
#   6. Verifies VM is running
#
# Prerequisites:
#   - Stage 0 completed (all bridges created)
#   - Security Onion OVF template available on NFS storage
#   - SSH access to Proxmox host
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml stage1/stage1_bootstrap_security_onion.yml
#   ansible-playbook -i inventory/hosts.yml stage1/stage1_bootstrap_security_onion.yml -e auto_confirm=true
#   ansible-playbook -i inventory/hosts.yml stage1/stage1_bootstrap_security_onion.yml -e max_student_groups=5
#
# Variables from inventory/group_vars/all.yml:
#   - proxmox_host, proxmox_user, proxmox_node
#   - security_onion.* (vmid, name, template, storage, etc.)
#   - bridges.* (spark_wan, instructor_lan)
#   - max_student_groups
#
# Author: Emily Miller
# Last Updated: December 1, 2025
# ============================================================================

- name: Stage 1 - Deploy Security Onion VM
  hosts: localhost
  connection: local
  gather_facts: yes

  tasks:
  # ========================================
  # Stage 1.1: Display Information
  # ========================================

  - name: Display stage information
    ansible.builtin.debug:
      msg: |
        ========================================
        STAGE 1: Security Onion VM Deployment
        ========================================

        This playbook will:
          1. Verify all required bridges exist
          2. Import Security Onion OVF template
          3. Configure VM hardware
          4. Assign {{ 2 + (max_student_groups * 2) }} network interfaces
          5. Start the VM
          6. Verify VM is running

        VM Configuration:
          - VM ID: {{ security_onion.vmid }}
          - Name: {{ security_onion.name }}
          - Template: {{ security_onion.template }}
          - Storage: {{ security_onion.storage }}
          - Management Bridge: {{ security_onion.management_bridge }}

        Network Interfaces:
          - net0: {{ security_onion.management_bridge }} (Management)
          - net1: {{ bridges.spark_wan }} (Monitor Spark WAN)
          - net2+: Student group monitoring ({{ max_student_groups }} groups)

        Total Interfaces: {{ 2 + (max_student_groups * 2) }}

        ========================================

  # ========================================
  # Stage 1.2: Pre-deployment Validation
  # ========================================

  - name: Test SSH connection to Proxmox
    ansible.builtin.command:
      cmd: ssh -o ConnectTimeout=5 {{ proxmox_user }}@{{ proxmox_host }} "echo 'Connection successful'"
    register: ssh_test
    changed_when: false
    failed_when: ssh_test.rc != 0

  - name: Display connection status
    ansible.builtin.debug:
      msg: "✓ SSH connection to Proxmox successful"
    when: ssh_test.rc == 0

  - name: Generate student group bridges list
    ansible.builtin.set_fact:
      student_bridges: "{{ student_bridges | default([]) + [bridge_wan, bridge_lan] }}"
    vars:
      bridge_wan: "vmbr255{{ '%03d' | format(item) }}"
      bridge_lan: "vmbr{{ '%03d' | format(item) }}000"
    loop: "{{ range(1, max_student_groups + 1) | list }}"

  - name: Combine infrastructure and student bridges
    ansible.builtin.set_fact:
      required_bridges: "{{ ['vmbr51', 'vmbr255000'] + student_bridges }}"

  - name: Display bridges to verify
    ansible.builtin.debug:
      msg: "Verifying {{ required_bridges | length }} bridges"

  - name: Display infrastructure bridges
    ansible.builtin.debug:
      msg: |
        Infrastructure:
          - vmbr51 (Spark WAN)
          - vmbr255000 (Instructor LAN)

  - name: Display student group bridges
    ansible.builtin.debug:
      msg: |
        Group {{ item }}:
          - vmbr255{{ (item | string).zfill(3) }} (WAN)
          - vmbr{{ (item | string).zfill(3) }}000 (LAN)
    loop: "{{ range(1, max_student_groups + 1) | list }}"

  - name: Verify required bridges exist
    ansible.builtin.command:
      cmd: ssh {{ proxmox_user }}@{{ proxmox_host }} "ip link show {{ item }}"
    loop: "{{ required_bridges }}"
    register: bridge_check
    changed_when: false
    failed_when: bridge_check.rc != 0

  - name: Display bridge verification
    ansible.builtin.debug:
      msg: "✓ All {{ required_bridges | length }} required bridges verified on Proxmox"

  - name: Check if VM already exists
    ansible.builtin.command:
      cmd: ssh {{ proxmox_user }}@{{ proxmox_host }} "qm status {{ security_onion.vmid }}"
    register: vm_exists
    changed_when: false
    failed_when: false

  - name: Stop if VM already exists
    ansible.builtin.fail:
      msg: |
        VM {{ security_onion.vmid }} already exists!
        
        Current status: {{ vm_exists.stdout }}
        
        If you want to recreate it, first destroy the existing VM:
          ssh {{ proxmox_user }}@{{ proxmox_host }} "qm stop {{ security_onion.vmid }} && qm destroy {{ security_onion.vmid }}"
    when: vm_exists.rc == 0

  - name: Check if OVF template exists
    ansible.builtin.command:
      cmd: ssh {{ proxmox_user }}@{{ proxmox_host }} "test -f {{ security_onion.template }}"
    register: template_check
    changed_when: false
    failed_when: template_check.rc != 0

  - name: Display template verification
    ansible.builtin.debug:
      msg: "✓ Security Onion OVF template found: {{ security_onion.template }}"
