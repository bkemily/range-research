---
# ============================================================================
# Generate All pfSense Configuration XMLs
# ============================================================================
# Purpose: Generate static XML configs for all pfSense instances
#
# Usage:
#   ansible-playbook stage2/generate_pfsense_configs.yml
#
# This creates:
#   - instructor.xml (with 15 OPT interfaces)
#   - group01.xml through group15.xml (student configs)
#
# Author: Emily Miller
# Last Updated: December 16, 2025
# ============================================================================

- name: Generate pfSense Configurations
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    max_student_groups: 15

  tasks:
  - name: Create configs output directory
    ansible.builtin.file:
      path: "{{ playbook_dir }}/pfsense_configs/generated"
      state: directory

  - name: Generate Instructor pfSense config
    ansible.builtin.template:
      src: "{{ playbook_dir }}/pfsense_configs/instructor-conf.xml.j2"
      dest: "{{ playbook_dir }}/pfsense_configs/generated/instructor.xml"
    vars:
      max_student_groups: 15

  - name: Generate Student Group configs
    ansible.builtin.template:
      src: "{{ playbook_dir }}/pfsense_configs/student-group-XX.xml.j2"
      dest: "{{ playbook_dir }}/pfsense_configs/generated/Group{{ item }}.xml"  # Changed format
    loop: "{{ range(1, 16) | list }}"
    vars:
      group_id: "{{ item }}"

  - name: Display generation complete
    ansible.builtin.debug:
      msg: |
        ========================================
        âœ“ Configuration Files Generated
        ========================================
        Location: {{ playbook_dir }}/pfsense_configs/generated/
        
        Files created:
          - instructor.xml
          - group01.xml through group15.xml
        
        Next steps:
          1. Review the generated XMLs
          2. Copy to pfSense template: /root/configs/
          3. Create apply_config.sh script on template
        ========================================
