---
# ============================================================================
# Playbook: Destroy pfSense Templates and VMs for Groups 3-15
# ============================================================================
# Purpose: Remove Proxmox templates and deployed VMs for student group pfSense gateways
#
# This playbook:
#   1. Loops through groups 3-15
#   2. Destroys each pfSense VM (if deployed)
#   3. Destroys each pfSense template
#
# VM IDs to Destroy:
#   - Group 3: 301
#   - Group 4: 401
#   - ...
#   - Group 15: 1501
#
# Template IDs to Destroy:
#   - Group 3: 8005
#   - Group 4: 8006
#   - ...
#   - Group 15: 8017
#
# WARNING: This is destructive and cannot be undone!
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml \
#     stage2/tasks/network/teardown_templates.yml \
#     --ask-vault-pass
#
# Author: Emily Miller
# Last Updated: December 28, 2025
# ============================================================================

- name: Destroy Student pfSense VMs and Templates for Groups 3-15
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: Display destruction warning
      ansible.builtin.debug:
        msg: |
          ========================================
          WARNING: Destroying pfSense VMs and Templates
          ========================================
          VMs to Destroy: Groups 3-{{ max_student_groups }} ({{ max_student_groups - 2 }} total)
          VM IDs: 301, 401, 501, ..., {{ vm_ids.student_base + ((max_student_groups - 1) * vm_ids.student_block_size) + 1 }}
          
          Templates to Destroy: Groups 3-{{ max_student_groups }} ({{ max_student_groups - 2 }} total)
          Template IDs: 8005, 8006, ..., {{ 8002 + max_student_groups }}
          
          This action CANNOT be undone!
          ========================================

    - name: Pause for confirmation
      ansible.builtin.pause:
        prompt: "Press ENTER to continue with destruction, or Ctrl+C to abort"

    # ========================================
    # Destroy Deployed VMs First
    # ========================================

    - name: Stop VM for Group {{ item }}
      ansible.builtin.command:
        cmd: >
          ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
          "qm stop {{ vm_ids.student_base + ((item - 1) * vm_ids.student_block_size) + 1 }}"
      loop: "{{ range(3, max_student_groups + 1) | list }}"
      register: stop_results
      changed_when: true
      failed_when: false

    - name: Display VM stop results
      ansible.builtin.debug:
        msg: "{{ '✓' if item.rc == 0 else '✗' }} Group {{ item.item }} VM {{ 'stopped' if item.rc == 0 else 'not found or already stopped' }} (VM {{ vm_ids.student_base + ((item.item - 1) * vm_ids.student_block_size) + 1 }})"
      loop: "{{ stop_results.results }}"
      loop_control:
        label: "Group {{ item.item }}"

    - name: Wait for VMs to stop
      ansible.builtin.pause:
        seconds: 3

    - name: Destroy VM for Group {{ item }}
      ansible.builtin.command:
        cmd: >
          ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
          "qm destroy {{ vm_ids.student_base + ((item - 1) * vm_ids.student_block_size) + 1 }}"
      loop: "{{ range(3, max_student_groups + 1) | list }}"
      register: vm_destroy_results
      changed_when: true
      failed_when: false

    - name: Display VM destruction results
      ansible.builtin.debug:
        msg: "{{ '✓' if item.rc == 0 else '✗' }} Group {{ item.item }} VM {{ 'destroyed' if item.rc == 0 else 'not found or error' }} (VM {{ vm_ids.student_base + ((item.item - 1) * vm_ids.student_block_size) + 1 }})"
      loop: "{{ vm_destroy_results.results }}"
      loop_control:
        label: "Group {{ item.item }}"

    # ========================================
    # Destroy Templates
    # ========================================

    - name: Destroy template for Group {{ item }}
      ansible.builtin.command:
        cmd: >
          ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
          "qm destroy {{ 8002 + item }}"
      loop: "{{ range(3, max_student_groups + 1) | list }}"
      register: template_destroy_results
      changed_when: true
      failed_when: false

    - name: Display template destruction results
      ansible.builtin.debug:
        msg: "{{ '✓' if item.rc == 0 else '✗' }} Group {{ item.item }} template {{ 'destroyed' if item.rc == 0 else 'not found or error' }} (VM {{ 8002 + item.item }})"
      loop: "{{ template_destroy_results.results }}"
      loop_control:
        label: "Group {{ item.item }}"

    - name: Display batch destruction summary
      ansible.builtin.debug:
        msg: |
          ========================================
          ✓ Destruction Complete
          ========================================
          Attempted to destroy VMs: Groups 3-{{ max_student_groups }} ({{ max_student_groups - 2 }} total)
          Attempted to destroy Templates: Groups 3-{{ max_student_groups }} ({{ max_student_groups - 2 }} total)
          ========================================