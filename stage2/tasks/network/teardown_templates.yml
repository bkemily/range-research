---
# ============================================================================
# Playbook: Destroy pfSense Templates for Groups 3-15
# ============================================================================
# Purpose: Remove Proxmox templates for student group pfSense gateways
#
# This playbook:
#   1. Loops through groups 3-15
#   2. Destroys each pfSense template
#
# Template IDs to Destroy:
#   - Group 3: 8005
#   - Group 4: 8006
#   - ...
#   - Group 15: 8017
#
# WARNING: This is destructive and cannot be undone!
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml \
#     stage2/tasks/network/teardown_templates.yml \
#     --ask-vault-pass
#
# Author: Emily Miller
# Last Updated: December 28, 2025
# ============================================================================

- name: Destroy Student pfSense Templates for Groups 3-15
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: Display destruction warning
      ansible.builtin.debug:
        msg: |
          ========================================
          WARNING: Destroying pfSense Templates
          ========================================
          Templates to Destroy: Groups 3-15 (13 total)
          Template IDs: 8005-8017
          This action CANNOT be undone!
          ========================================

    - name: Pause for confirmation
      ansible.builtin.pause:
        prompt: "Press ENTER to continue with template destruction, or Ctrl+C to abort"

    # ========================================
    # Loop Through Groups 3-15
    # ========================================

    - name: Set template ID for Group {{ item }}
      ansible.builtin.set_fact:
        current_template_id: "{{ 8002 + item }}"
      loop: "{{ range(3, 16) | list }}"
      register: template_ids

    - name: Destroy template for Group {{ item }}
      ansible.builtin.command:
        cmd: >
          ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
          "qm destroy {{ 8002 + item }}"
      loop: "{{ range(3, 16) | list }}"
      register: destroy_results
      changed_when: true
      failed_when: false

    - name: Display destruction results
      ansible.builtin.debug:
        msg: "{{ '✓' if item.rc == 0 else '✗' }} Group {{ item.item }} template {{ 'destroyed' if item.rc == 0 else 'not found or error' }} (VM {{ 8002 + item.item }})"
      loop: "{{ destroy_results.results }}"
      loop_control:
        label: "Group {{ item.item }}"

    - name: Display batch destruction summary
      ansible.builtin.debug:
        msg: |
          ========================================
          ✓ Template Destruction Complete
          ========================================
          Attempted to destroy: Groups 3-15 (13 total)
          Template IDs: 8005-8017
          ========================================