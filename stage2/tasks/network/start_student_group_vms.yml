---
# ============================================================================
# Task: Start Student Group Client VMs
# ============================================================================
# Purpose: Start all client VMs for a specific student group
#
# Called by: configure_network.yml (looped for each group)
#
# This task file:
#   1. Calculates VM IDs for the group
#   2. Starts Kali 1
#   3. Starts Kali 2
#   4. Starts MS3 Ubuntu
#   5. Starts MS3 Windows
#   6. Waits for QEMU guest agent to be available
#   7. Triggers DHCP renewal via guest agent commands
#
# Input Variables:
#   - group_id: Student group number (1-15)
#
# VM ID Calculation (per group):
#   - Kali 1:   200 + ((group_id - 1) * 100) + 2  (e.g., Group 1 = 202, Group 2 = 302)
#   - Kali 2:   200 + ((group_id - 1) * 100) + 3  (e.g., Group 1 = 203, Group 2 = 303)
#   - Ubuntu:   200 + ((group_id - 1) * 100) + 4  (e.g., Group 1 = 204, Group 2 = 304)
#   - Windows:  200 + ((group_id - 1) * 100) + 5  (e.g., Group 1 = 205, Group 2 = 305)
#
# Author: Emily Miller
# Last Updated: December 31, 2025
# ============================================================================

- name: Display Student Group VM startup notice
  ansible.builtin.debug:
    msg: |
      ========================================
      Starting Client VMs for Group {{ group_id }}
      ========================================
      VMs to start:
        - Kali 1:         VM {{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 2 }}
        - Kali 2:         VM {{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 3 }}
        - MS3 Ubuntu:     VM {{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 4 }}
        - MS3 Windows:    VM {{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 5 }}
      ========================================

# ========================================
# Calculate VM IDs for this Group
# ========================================

- name: Calculate VM IDs for Group {{ group_id }}
  ansible.builtin.set_fact:
    group_kali1_id: "{{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 2 }}"
    group_kali2_id: "{{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 3 }}"
    group_ubuntu_id: "{{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 4 }}"
    group_windows_id: "{{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 5 }}"
    expected_kali1_ip: "143.88.{{ group_id }}.10"
    expected_kali2_ip: "143.88.{{ group_id }}.11"
    expected_ubuntu_ip: "143.88.{{ group_id }}.13"
    expected_windows_ip: "143.88.{{ group_id }}.14"

- name: Display Group {{ group_id }} VM IDs
  ansible.builtin.debug:
    msg: |
      Group {{ group_id }} Configuration:
        Kali 1:   {{ group_kali1_id }}
        Kali 2:   {{ group_kali2_id }}
        Ubuntu:   {{ group_ubuntu_id }}
        Windows:  {{ group_windows_id }}

# ========================================
# Start Client VMs
# ========================================

- name: Start Group {{ group_id }} Kali 1 (VM {{ group_kali1_id }})
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm start {{ group_kali1_id }}"
  register: start_kali1
  changed_when: true
  failed_when: start_kali1.rc != 0

- name: Start Group {{ group_id }} Kali 2 (VM {{ group_kali2_id }})
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm start {{ group_kali2_id }}"
  register: start_kali2
  changed_when: true
  failed_when: start_kali2.rc != 0

- name: Start Group {{ group_id }} MS3 Ubuntu (VM {{ group_ubuntu_id }})
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm start {{ group_ubuntu_id }}"
  register: start_ubuntu
  changed_when: true
  failed_when: start_ubuntu.rc != 0

- name: Start Group {{ group_id }} MS3 Windows (VM {{ group_windows_id }})
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm start {{ group_windows_id }}"
  register: start_windows
  changed_when: true
  failed_when: start_windows.rc != 0

# ========================================
# Wait for VMs to Boot
# ========================================

- name: Wait for Group {{ group_id }} VMs to boot (30 seconds)
  ansible.builtin.pause:
    seconds: 30
    prompt: "Waiting for Group {{ group_id }} VMs to complete boot sequence..."

# ========================================
# Trigger DHCP via Guest Agent
# ========================================

- name: Trigger DHCP for Group {{ group_id }} Kali 1 via guest agent
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm guest exec {{ group_kali1_id }} -- /bin/bash -c 'dhclient -r && dhclient'"
  register: kali1_dhcp
  changed_when: false
  failed_when: false

- name: Display Kali 1 DHCP result
  ansible.builtin.debug:
    msg: |
      Kali 1 DHCP Trigger Result:
        Return Code: {{ kali1_dhcp.rc }}
        STDOUT: {{ kali1_dhcp.stdout }}
        STDERR: {{ kali1_dhcp.stderr }}

- name: Trigger DHCP for Group {{ group_id }} Kali 2 via guest agent
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm guest exec {{ group_kali2_id }} -- /bin/bash -c 'dhclient -r && dhclient'"
  register: kali2_dhcp
  changed_when: false
  failed_when: false

- name: Display Kali 2 DHCP result
  ansible.builtin.debug:
    msg: |
      Kali 2 DHCP Trigger Result:
        Return Code: {{ kali2_dhcp.rc }}
        STDOUT: {{ kali2_dhcp.stdout }}
        STDERR: {{ kali2_dhcp.stderr }}

- name: Trigger DHCP for Group {{ group_id }} MS3 Ubuntu via guest agent
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm guest exec {{ group_ubuntu_id }} -- /bin/bash -c 'dhclient -r && dhclient'"
  register: ubuntu_dhcp
  changed_when: false
  failed_when: false

- name: Display MS3 Ubuntu DHCP result
  ansible.builtin.debug:
    msg: |
      MS3 Ubuntu DHCP Trigger Result:
        Return Code: {{ ubuntu_dhcp.rc }}
        STDOUT: {{ ubuntu_dhcp.stdout }}
        STDERR: {{ ubuntu_dhcp.stderr }}

- name: Trigger DHCP for Group {{ group_id }} MS3 Windows via guest agent
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm guest exec {{ group_windows_id }} -- cmd.exe /c 'ipconfig /renew'"
  register: windows_dhcp
  changed_when: false
  failed_when: false

- name: Display MS3 Windows DHCP result
  ansible.builtin.debug:
    msg: |
      MS3 Windows DHCP Trigger Result:
        Return Code: {{ windows_dhcp.rc }}
        STDOUT: {{ windows_dhcp.stdout }}
        STDERR: {{ windows_dhcp.stderr }}

# ========================================
# Verify IP Assignment
# ========================================

- name: Get Kali 1 IP address via guest agent
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm guest exec {{ group_kali1_id }} -- ip -4 addr show"
  register: kali1_ip_check
  changed_when: false
  failed_when: false

- name: Get Kali 2 IP address via guest agent
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm guest exec {{ group_kali2_id }} -- ip -4 addr show"
  register: kali2_ip_check
  changed_when: false
  failed_when: false

- name: Get MS3 Ubuntu IP address via guest agent
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm guest exec {{ group_ubuntu_id }} -- ip -4 addr show"
  register: ubuntu_ip_check
  changed_when: false
  failed_when: false

- name: Get MS3 Windows IP address via guest agent
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm guest exec {{ group_windows_id }} -- ipconfig"
  register: windows_ip_check
  changed_when: false
  failed_when: false

# ========================================
# Display Completion
# ========================================

- name: Display Group {{ group_id }} startup completion
  ansible.builtin.debug:
    msg: |
      ========================================
      âœ“ Group {{ group_id }} Client VMs Started
      ========================================
      VMs:
        - Kali 1:         VM {{ group_kali1_id }} (expected {{ expected_kali1_ip }})
        - Kali 2:         VM {{ group_kali2_id }} (expected {{ expected_kali2_ip }})
        - MS3 Ubuntu:     VM {{ group_ubuntu_id }} (expected {{ expected_ubuntu_ip }})
        - MS3 Windows:    VM {{ group_windows_id }} (expected {{ expected_windows_ip }})

      DHCP Trigger Status:
        - Kali 1:   RC={{ kali1_dhcp.rc }}
        - Kali 2:   RC={{ kali2_dhcp.rc }}
        - Ubuntu:   RC={{ ubuntu_dhcp.rc }}
        - Windows:  RC={{ windows_dhcp.rc }}

      IP Verification:
        - Kali 1:   {{ 'Got IPs' if kali1_ip_check.rc == 0 else 'Failed to check' }}
        - Kali 2:   {{ 'Got IPs' if kali2_ip_check.rc == 0 else 'Failed to check' }}
        - Ubuntu:   {{ 'Got IPs' if ubuntu_ip_check.rc == 0 else 'Failed to check' }}
        - Windows:  {{ 'Got IPs' if windows_ip_check.rc == 0 else 'Failed to check' }}
      ========================================

- name: Display Kali 1 IP information
  ansible.builtin.debug:
    var: kali1_ip_check.stdout_lines
  when: kali1_ip_check.rc == 0

- name: Display Kali 2 IP information
  ansible.builtin.debug:
    var: kali2_ip_check.stdout_lines
  when: kali2_ip_check.rc == 0

- name: Display Ubuntu IP information
  ansible.builtin.debug:
    var: ubuntu_ip_check.stdout_lines
  when: ubuntu_ip_check.rc == 0

- name: Display Windows IP information
  ansible.builtin.debug:
    var: windows_ip_check.stdout_lines
  when: windows_ip_check.rc == 0
