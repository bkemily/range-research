---
# ============================================================================
# Task: Start Student Group Client VMs
# ============================================================================
# Purpose: Start all client VMs for a specific student group
#
# Called by: configure_network.yml (looped for each group)
#
# This task file:
#   1. Calculates VM IDs for the group
#   2. Starts Kali 1
#   3. Starts Kali 2
#   4. Starts MS3 Ubuntu
#   5. Starts MS3 Windows
#   6. Waits for VMs to boot
#   7. Logs into each VM to trigger DHCP IP assignment
#
# Input Variables:
#   - group_id: Student group number (1-15)
#
# VM ID Calculation (per group):
#   - Kali 1:   200 + ((group_id - 1) * 100) + 2  (e.g., Group 1 = 202, Group 2 = 302)
#   - Kali 2:   200 + ((group_id - 1) * 100) + 3  (e.g., Group 1 = 203, Group 2 = 303)
#   - Ubuntu:   200 + ((group_id - 1) * 100) + 4  (e.g., Group 1 = 204, Group 2 = 304)
#   - Windows:  200 + ((group_id - 1) * 100) + 5  (e.g., Group 1 = 205, Group 2 = 305)
#
# Default Credentials:
#   - Kali VMs: kali/kali
#   - MS3 VMs:  vagrant/vagrant
#
# Author: Emily Miller
# Last Updated: December 31, 2025
# ============================================================================

- name: Display Student Group VM startup notice
  ansible.builtin.debug:
    msg: |
      ========================================
      Starting Client VMs for Group {{ group_id }}
      ========================================
      VMs to start:
        - Kali 1:         VM {{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 2 }}
        - Kali 2:         VM {{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 3 }}
        - MS3 Ubuntu:     VM {{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 4 }}
        - MS3 Windows:    VM {{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 5 }}
      ========================================

# ========================================
# Calculate VM IDs for this Group
# ========================================

- name: Calculate VM IDs for Group {{ group_id }}
  ansible.builtin.set_fact:
    group_kali1_id: "{{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 2 }}"
    group_kali2_id: "{{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 3 }}"
    group_ubuntu_id: "{{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 4 }}"
    group_windows_id: "{{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 5 }}"
    expected_kali1_ip: "143.88.{{ group_id }}.100"
    expected_kali2_ip: "143.88.{{ group_id }}.101"
    expected_ubuntu_ip: "143.88.{{ group_id }}.102"
    expected_windows_ip: "143.88.{{ group_id }}.103"

- name: Display Group {{ group_id }} VM IDs
  ansible.builtin.debug:
    msg: |
      Group {{ group_id }} Configuration:
        Kali 1:   {{ group_kali1_id }}
        Kali 2:   {{ group_kali2_id }}
        Ubuntu:   {{ group_ubuntu_id }}
        Windows:  {{ group_windows_id }}

# ========================================
# Start Client VMs
# ========================================

- name: Start Group {{ group_id }} Kali 1 (VM {{ group_kali1_id }})
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm start {{ group_kali1_id }}"
  register: start_kali1
  changed_when: true
  failed_when: start_kali1.rc != 0

- name: Start Group {{ group_id }} Kali 2 (VM {{ group_kali2_id }})
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm start {{ group_kali2_id }}"
  register: start_kali2
  changed_when: true
  failed_when: start_kali2.rc != 0

- name: Start Group {{ group_id }} MS3 Ubuntu (VM {{ group_ubuntu_id }})
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm start {{ group_ubuntu_id }}"
  register: start_ubuntu
  changed_when: true
  failed_when: start_ubuntu.rc != 0

- name: Start Group {{ group_id }} MS3 Windows (VM {{ group_windows_id }})
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm start {{ group_windows_id }}"
  register: start_windows
  changed_when: true
  failed_when: start_windows.rc != 0

# ========================================
# Wait for VMs to Boot
# ========================================

- name: Wait for Group {{ group_id }} VMs to boot (60 seconds)
  ansible.builtin.pause:
    seconds: 60
    prompt: "Waiting for Group {{ group_id }} VMs to complete boot sequence..."

# ========================================
# Trigger DHCP via SSH Login
# ========================================

- name: Trigger DHCP for Group {{ group_id }} Kali 1 via SSH login
  ansible.builtin.shell: |
    sshpass -p 'kali' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
    -o ConnectTimeout=10 kali@{{ expected_kali1_ip }} 'ip addr show' || true
  register: kali1_dhcp
  changed_when: false
  failed_when: false

- name: Trigger DHCP for Group {{ group_id }} Kali 2 via SSH login
  ansible.builtin.shell: |
    sshpass -p 'kali' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
    -o ConnectTimeout=10 kali@{{ expected_kali2_ip }} 'ip addr show' || true
  register: kali2_dhcp
  changed_when: false
  failed_when: false

- name: Trigger DHCP for Group {{ group_id }} MS3 Ubuntu via SSH login
  ansible.builtin.shell: |
    sshpass -p 'vagrant' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
    -o ConnectTimeout=10 vagrant@{{ expected_ubuntu_ip }} 'ip addr show' || true
  register: ubuntu_dhcp
  changed_when: false
  failed_when: false

- name: Trigger DHCP for Group {{ group_id }} MS3 Windows via SSH login
  ansible.builtin.shell: |
    sshpass -p 'vagrant' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
    -o ConnectTimeout=10 vagrant@{{ expected_windows_ip }} 'ipconfig /all' || true
  register: windows_dhcp
  changed_when: false
  failed_when: false

# ========================================
# Display Completion
# ========================================

- name: Display Group {{ group_id }} startup completion
  ansible.builtin.debug:
    msg: |
      ========================================
      âœ“ Group {{ group_id }} Client VMs Started
      ========================================
      VMs:
        - Kali 1:         VM {{ group_kali1_id }} ({{ expected_kali1_ip }})
        - Kali 2:         VM {{ group_kali2_id }} ({{ expected_kali2_ip }})
        - MS3 Ubuntu:     VM {{ group_ubuntu_id }} ({{ expected_ubuntu_ip }})
        - MS3 Windows:    VM {{ group_windows_id }} ({{ expected_windows_ip }})

      DHCP Trigger Status:
        - Kali 1:   {{ 'SUCCESS' if kali1_dhcp.rc == 0 else 'FAILED (may still be booting)' }}
        - Kali 2:   {{ 'SUCCESS' if kali2_dhcp.rc == 0 else 'FAILED (may still be booting)' }}
        - Ubuntu:   {{ 'SUCCESS' if ubuntu_dhcp.rc == 0 else 'FAILED (may still be booting)' }}
        - Windows:  {{ 'SUCCESS' if windows_dhcp.rc == 0 else 'FAILED (may still be booting)' }}
      ========================================
