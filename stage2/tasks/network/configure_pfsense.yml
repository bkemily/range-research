---
# ============================================================================
# Task: Configure pfSense via Pre-loaded Config Script
# ============================================================================
# Purpose: Run existing config.sh script with group number
#
# Variables Required:
#   - group_number: Group number (1-15) or "instructor"
#   - vm_name: Descriptive name for logging
#
# Author: Emily Miller
# Last Updated: December 16, 2025
# ============================================================================

- name: Display pfSense configuration notice
  ansible.builtin.debug:
    msg: |
      ========================================
      Configuring {{ vm_name }}
      ========================================
      Group: {{ group_number }}
      ========================================

- name: Wait for pfSense SSH to be available
  ansible.builtin.wait_for:
    host: "143.88.1.1"
    port: 22
    timeout: 300
    state: started
  delegate_to: localhost

- name: Run config.sh script
  ansible.builtin.shell:
    cmd: |
      sshpass -p '{{ pfsense_default_password }}' ssh {{ ssh.common_args }} {{ pfsense_default_user }}@143.88.1.1 << 'EOF'
      echo "{{ group_number }}" | /root/config.sh
      EOF
  register: config_result
  changed_when: true
  failed_when: false

- name: Display configuration status
  ansible.builtin.debug:
    msg: "✓ Configuration script executed, {{ vm_name }} rebooting..."

- name: Wait for pfSense to reboot
  ansible.builtin.pause:
    seconds: "{{ automation.pfsense_boot_wait_seconds }}"

- name: Display completion
  ansible.builtin.debug:
    msg: "✓ {{ vm_name }} configured"
