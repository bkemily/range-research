---
# ============================================================================
# Task: Configure pfSense via XML
# ============================================================================
# Purpose: Deploy pre-configured XML to pfSense and apply settings
#
# This approach:
#   1. Copies XML config to pfSense via SCP
#   2. Backs up existing config
#   3. Applies new config
#   4. Reboots pfSense
#
# Variables Required:
#   - pfsense_ip: Management IP of pfSense
#   - pfsense_user: SSH username (default: admin)
#   - pfsense_password: SSH password
#   - config_file: Path to XML config file
#   - vm_name: Descriptive name for logging
#
# Author: Emily Miller
# Last Updated: December 15, 2025
# ============================================================================

- name: Display pfSense configuration notice
  ansible.builtin.debug:
    msg: |
      ========================================
      Configuring {{ vm_name }}
      ========================================
      IP: {{ pfsense_ip }}
      Config: {{ config_file }}
      ========================================

- name: Wait for pfSense SSH to be available
  ansible.builtin.wait_for:
    host: "{{ pfsense_ip }}"
    port: 22
    timeout: 300
    state: started
  delegate_to: localhost

- name: Backup existing pfSense configuration
  ansible.builtin.command:
    cmd: >
      sshpass -p '{{ pfsense_password }}' ssh {{ ssh.common_args }} {{ pfsense_user }}@{{ pfsense_ip }} "cp /cf/conf/config.xml /cf/conf/config.xml.bak.$(date +%Y%m%d_%H%M%S)"
  register: backup_result
  changed_when: true
  failed_when: backup_result.rc != 0

- name: Copy pfSense configuration XML
  ansible.builtin.command:
    cmd: >
      sshpass -p '{{ pfsense_password }}' scp {{ ssh.common_args }} {{ config_file }} {{ pfsense_user }}@{{ pfsense_ip }}:/cf/conf/config.xml
  register: copy_result
  changed_when: true
  failed_when: copy_result.rc != 0

- name: Display configuration copy status
  ansible.builtin.debug:
    msg: "✓ Configuration copied to {{ vm_name }}"

- name: Reboot pfSense to apply configuration
  ansible.builtin.command:
    cmd: >
      sshpass -p '{{ pfsense_password }}' ssh {{ ssh.common_args }} {{ pfsense_user }}@{{ pfsense_ip }} "/sbin/reboot"
  register: reboot_result
  changed_when: true
  failed_when: false
  async: 0
  poll: 0

- name: Wait for pfSense to reboot
  ansible.builtin.pause:
    seconds: "{{ automation.pfsense_boot_wait_seconds }}"
    prompt: "Waiting {{ automation.pfsense_boot_wait_seconds }} seconds for {{ vm_name }} to reboot..."

- name: Verify pfSense is back online
  ansible.builtin.wait_for:
    host: "{{ pfsense_ip }}"
    port: 22
    timeout: 300
    state: started
  delegate_to: localhost

- name: Display configuration completion
  ansible.builtin.debug:
    msg: |
      ========================================
      ✓ {{ vm_name }} Configuration Complete
      ========================================
      New configuration applied and system rebooted
      ========================================
