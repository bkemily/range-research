---
# ============================================================================
# Playbook: Create pfSense Templates for Groups 3-15
# ============================================================================
# Purpose: Create Proxmox templates for student group pfSense gateways
#
# This playbook:
#   1. Loops through groups 3-15
#   2. Clones Group 2 pfSense template as base for each
#   3. Updates network bridges for each group
#   4. Converts each to template
#
# Template Configuration (per group):
#   - Template ID: 8002 + group_id (e.g., Group 3 = 8005, Group 4 = 8006)
#   - Base: Group 2 pfSense template (8002)
#   - Network Interfaces:
#       * net0: vmbr255{group_id:03d} (WAN to Instructor pfSense OPT{group_id})
#       * net1: vmbr{group_id:03d}000 (Group LAN)
#
# Example for Group 3:
#   - Template ID: 8005
#   - net0: vmbr255003 (WAN to Instructor)
#   - net1: vmbr003000 (Group 3 LAN)
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml \
#     stage2/tasks/infrastructure/create_student_pfsense_templates.yml \
#     --ask-vault-pass
#
# Author: Emily Miller
# Last Updated: December 28, 2025
# ============================================================================

- name: Create Student pfSense Templates for Groups 3-15
  hosts: localhost
  connection: local
  gather_facts: no
  
  tasks:
    - name: Display batch template creation notice
      ansible.builtin.debug:
        msg: |
          ========================================
          Creating pfSense Templates for Groups 3-15
          ========================================
          Base Template: VM {{ templates.group2_pfsense_template_id }}
          Templates to Create: 13
          Storage: {{ storage }}
          ========================================

    # ========================================
    # Loop Through Groups 3-15
    # ========================================

    - name: Create pfSense templates for groups 3-15
      block:
        - name: Set template ID and bridges for Group {{ item }}
          ansible.builtin.set_fact:
            current_template_id: "{{ 8002 + item }}"
            wan_bridge: "vmbr255{{ '%03d' | format(item) }}"
            lan_bridge: "vmbr{{ '%03d' | format(item) }}000"

        - name: Display Group {{ item }} template creation notice
          ansible.builtin.debug:
            msg: |
              ========================================
              Creating Group {{ item }} pfSense Template
              ========================================
              Template ID: {{ current_template_id }}
              WAN Bridge: {{ wan_bridge }}
              LAN Bridge: {{ lan_bridge }}
              ========================================

        - name: Clone Group 2 pfSense template for Group {{ item }}
          ansible.builtin.command:
            cmd: >
              ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
              "qm clone {{ templates.group2_pfsense_template_id }} {{ current_template_id }}
              --name pfsense-group{{ '%02d' | format(item) }}-template --full"
          register: clone_result
          changed_when: true
          failed_when: clone_result.rc != 0

        - name: Wait for clone operation to complete
          ansible.builtin.pause:
            seconds: 3

        - name: Update WAN bridge for Group {{ item }}
          ansible.builtin.command:
            cmd: >
              ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
              "qm set {{ current_template_id }}
              --net0 virtio,bridge={{ wan_bridge }}"
          register: wan_result
          changed_when: true
          failed_when: wan_result.rc != 0

        - name: Update LAN bridge for Group {{ item }}
          ansible.builtin.command:
            cmd: >
              ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
              "qm set {{ current_template_id }}
              --net1 virtio,bridge={{ lan_bridge }}"
          register: lan_result
          changed_when: true
          failed_when: lan_result.rc != 0

        - name: Convert VM to template for Group {{ item }}
          ansible.builtin.command:
            cmd: >
              ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
              "qm template {{ current_template_id }}"
          register: template_result
          changed_when: true
          failed_when: template_result.rc != 0

        - name: Display Group {{ item }} template completion
          ansible.builtin.debug:
            msg: "✓ Group {{ item }} pfSense template created (VM {{ current_template_id }})"

      loop: "{{ range(3, 16) | list }}"

    - name: Display batch completion summary
      ansible.builtin.debug:
        msg: |
          ========================================
          ✓ All pfSense Templates Created
          ========================================
          Templates Created: Groups 3-15 (13 total)
          Template IDs: 8005-8017
          Ready for deployment!
          ========================================