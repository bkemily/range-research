---
# ============================================================================
# Playbook: Create pfSense Templates for Groups 3-15
# ============================================================================
# Purpose: Create Proxmox templates for student group pfSense gateways
#
# This playbook:
#   1. Loops through groups 3-15
#   2. Clones Group 2 pfSense template as base for each
#   3. Updates network bridges for each group
#   4. Converts each to template
#
# Template Configuration (per group):
#   - Template ID: 8002 + group_id (e.g., Group 3 = 8005, Group 4 = 8006)
#   - Base: Group 2 pfSense template (8002)
#   - Network Interfaces:
#       * net0: vmbr255{group_id:03d} (WAN to Instructor pfSense OPT{group_id})
#       * net1: vmbr{group_id:03d}000 (Group LAN)
#
# Example for Group 3:
#   - Template ID: 8005
#   - net0: vmbr255003 (WAN to Instructor)
#   - net1: vmbr003000 (Group 3 LAN)
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml \
#     stage2/tasks/infrastructure/create_student_pfsense_templates.yml \
#     --ask-vault-pass
#
# Author: Emily Miller
# Last Updated: December 28, 2025
# ============================================================================

- name: Create Student pfSense Templates for Groups 3-15
  hosts: localhost
  connection: local
  gather_facts: no
  
  tasks:
    - name: Display batch template creation notice
      ansible.builtin.debug:
        msg: |
          ========================================
          Creating pfSense Templates for Groups 3-15
          ========================================
          Base Template: VM {{ templates.group2_pfsense_template_id }}
          Templates to Create: 13
          Storage: {{ storage }}
          ========================================

    # ========================================
    # Loop Through Groups 3-15
    # ========================================

    - name: Set template ID and bridges for Group {{ item }}
      ansible.builtin.set_fact:
        current_template_id: "{{ 8002 + item }}"
        wan_bridge: "vmbr255{{ '%03d' | format(item) }}"
        lan_bridge: "vmbr{{ '%03d' | format(item) }}000"
        current_group: "{{ item }}"
      loop: "{{ range(3, 16) | list }}"
      register: group_facts

    - name: Create templates for each group
      ansible.builtin.include_tasks: create_single_temp.yml
      loop: "{{ range(3, 16) | list }}"
      loop_control:
        loop_var: group_id

    - name: Display batch completion summary
      ansible.builtin.debug:
        msg: |
          ========================================
          âœ“ All pfSense Templates Created
          ========================================
          Templates Created: Groups 3-15 (13 total)
          Template IDs: 8005-8017
          Ready for deployment!
          ========================================