---
# ============================================================================
# Task: Initialize pfSense via Console
# ============================================================================
# Purpose: Automate initial pfSense setup via console before SSH is available
#
# This task:
#   1. Answers "no" to VLAN setup
#   2. Assigns vtnet0 to WAN
#   3. Assigns vtnet1 to LAN
#   4. Waits for interfaces to be configured
#
# Variables Required:
#   - pfsense_vm_id: VM ID of the pfSense
#   - vm_name: Descriptive name for logging
#
# Author: Emily Miller
# Last Updated: December 16, 2025
# ============================================================================

- name: Display pfSense console initialization notice
  ansible.builtin.debug:
    msg: |
      ========================================
      Initializing {{ vm_name }} via Console
      ========================================
      VM ID: {{ pfsense_vm_id }}
      ========================================

- name: Wait for pfSense VLAN prompt
  ansible.builtin.pause:
    seconds: 15
    prompt: "Waiting for {{ vm_name }} to reach VLAN setup prompt..."

- name: Create initialization script
  ansible.builtin.template:
    src: initialize_pfsense.sh.j2
    dest: /tmp/init_pfsense_{{ pfsense_vm_id }}.sh
    mode: '0755'
  delegate_to: localhost

- name: Copy script to Proxmox
  ansible.builtin.command:
    cmd: >
      scp {{ ssh.common_args }}
      /tmp/init_pfsense_{{ pfsense_vm_id }}.sh
      {{ proxmox_user }}@{{ proxmox_host }}:/tmp/
  changed_when: true

- name: Execute initialization script on Proxmox
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
      "bash /tmp/init_pfsense_{{ pfsense_vm_id }}.sh"
  register: console_init
  changed_when: true

- name: Wait for interface assignment to complete
  ansible.builtin.pause:
    seconds: 30

- name: Display initialization completion
  ansible.builtin.debug:
    msg: "âœ“ {{ vm_name }} initialized"
