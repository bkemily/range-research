---
# ============================================================================
# Task: Initialize pfSense via Console
# ============================================================================
# Purpose: Automate initial pfSense setup via console before SSH is available
#
# This task:
#   1. Answers "no" to VLAN setup
#   2. Assigns vtnet0 to WAN
#   3. Assigns vtnet1 to LAN
#   4. Waits for interfaces to be configured
#
# Variables Required:
#   - pfsense_vm_id: VM ID of the pfSense
#   - vm_name: Descriptive name for logging
#
# Author: Emily Miller
# Last Updated: December 16, 2025
# ============================================================================

---
- name: Display pfSense console initialization notice
  ansible.builtin.debug:
    msg: |
      ========================================
      Initializing {{ vm_name }} via Console
      ========================================
      VM ID: {{ pfsense_vm_id }}
      ========================================

- name: Wait for pfSense VLAN prompt
  ansible.builtin.pause:
    seconds: 15
    prompt: "Waiting for {{ vm_name }} to reach VLAN setup prompt..."

- name: Send interface assignment keystrokes
  ansible.builtin.shell:
    cmd: |
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} << 'ENDSCRIPT'
      # No VLANs
      qm monitor {{ pfsense_vm_id }} sendkey n
      sleep 0.5
      qm monitor {{ pfsense_vm_id }} sendkey ret
      sleep 2
      
      # WAN interface: vtnet0
      qm monitor {{ pfsense_vm_id }} sendkey v
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey t
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey n
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey e
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey t
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey 0
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey ret
      sleep 2
      
      # LAN interface: vtnet1
      qm monitor {{ pfsense_vm_id }} sendkey v
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey t
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey n
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey e
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey t
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey 1
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey ret
      sleep 2
      
      # No optional interfaces
      qm monitor {{ pfsense_vm_id }} sendkey ret
      sleep 2
      
      # Proceed: y
      qm monitor {{ pfsense_vm_id }} sendkey y
      sleep 0.1
      qm monitor {{ pfsense_vm_id }} sendkey ret
      ENDSCRIPT
  register: console_init
  changed_when: true

- name: Wait for interface assignment to complete
  ansible.builtin.pause:
    seconds: 30
    prompt: "Waiting for {{ vm_name }} to complete interface assignment..."

- name: Display initialization completion
  ansible.builtin.debug:
    msg: "âœ“ {{ vm_name }} initialized - default LAN IP should be 192.168.1.1"
