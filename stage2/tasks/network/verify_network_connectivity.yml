---
# stage2/tasks/network/verify_network_connectivity.yml
# Network Connectivity Validation Playbook

- name: Network Connectivity Testing
  hosts: localhost
  gather_facts: false
  vars:
    test_timestamp: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"
    results_dir: "{{ playbook_dir }}/../../../test_results"
    pfsense_user: "admin"
    pfsense_pass: "pfsense"
    
  tasks:
    - name: Load inventory variables
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../../inventory/group_vars/all.yml"

    - name: Generate student groups
      ansible.builtin.set_fact:
        student_groups: "{{ student_groups | default([]) + [{'group_id': item, 'group_name': 'Group' + item|string, 'vlan_id': 100 + item, 'wan_ip': '143.88.0.' + (item * 2)|string, 'lan_ip': '143.88.' + item|string + '.1', 'lan_network': '143.88.' + item|string + '.0/24'}] }}"
      loop: "{{ range(1, max_student_groups + 1) | list }}"

    - name: Set pfSense IPs
      ansible.builtin.set_fact:
        instructor_wan: "143.88.0.1"
        instructor_lan: "143.88.255.1"
        so_ip: "143.88.255.9"

    - name: Create results directory
      ansible.builtin.file:
        path: "{{ results_dir }}"
        state: directory
        mode: '0755'

    - name: Create results file
      ansible.builtin.file:
        path: "{{ results_dir }}/connectivity_test_{{ test_timestamp }}.log"
        state: touch
        mode: '0644'

    - name: Display test start
      ansible.builtin.debug:
        msg: "Testing {{ student_groups | length }} student groups"

    # Test 1: Instructor to Student WAN
    - name: Ping student WAN from instructor
      ansible.builtin.shell:
        cmd: "sshpass -p '{{ pfsense_pass }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ pfsense_user }}@{{ instructor_wan }} 'ping -c 3 {{ item.wan_ip }}'"
      loop: "{{ student_groups }}"
      register: test1
      ignore_errors: true
      changed_when: false

    - name: Log test 1 results
      ansible.builtin.lineinfile:
        path: "{{ results_dir }}/connectivity_test_{{ test_timestamp }}.log"
        line: "[TEST1] Instructor->{{ item.item.group_name }} WAN ({{ item.item.wan_ip }}): {{ 'PASS' if item.rc == 0 else 'FAIL' }}"
      loop: "{{ test1.results }}"

    # Test 2: Instructor to Student LAN
    - name: Ping student LAN from instructor
      ansible.builtin.shell:
        cmd: "sshpass -p '{{ pfsense_pass }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ pfsense_user }}@{{ instructor_wan }} 'ping -c 3 {{ item.lan_ip }}'"
      loop: "{{ student_groups }}"
      register: test2
      ignore_errors: true
      changed_when: false

    - name: Log test 2 results
      ansible.builtin.lineinfile:
        path: "{{ results_dir }}/connectivity_test_{{ test_timestamp }}.log"
        line: "[TEST2] Instructor->{{ item.item.group_name }} LAN ({{ item.item.lan_ip }}): {{ 'PASS' if item.rc == 0 else 'FAIL' }}"
      loop: "{{ test2.results }}"

    # Test 3: Student to Instructor
    - name: Ping instructor from student
      ansible.builtin.shell:
        cmd: "sshpass -p '{{ pfsense_pass }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ pfsense_user }}@{{ item.wan_ip }} 'ping -c 3 {{ instructor_wan }}'"
      loop: "{{ student_groups }}"
      register: test3
      ignore_errors: true
      changed_when: false

    - name: Log test 3 results
      ansible.builtin.lineinfile:
        path: "{{ results_dir }}/connectivity_test_{{ test_timestamp }}.log"
        line: "[TEST3] {{ item.item.group_name }}->Instructor: {{ 'PASS' if item.rc == 0 else 'FAIL' }}"
      loop: "{{ test3.results }}"

    # Test 4: Cross-student WAN
    - name: Ping cross-student WAN
      ansible.builtin.shell:
        cmd: "sshpass -p '{{ pfsense_pass }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ pfsense_user }}@{{ item.0.wan_ip }} 'ping -c 3 {{ item.1.wan_ip }}'"
      loop: "{{ student_groups | product(student_groups) | list }}"
      when: item.0.group_id != item.1.group_id
      register: test4
      ignore_errors: true
      changed_when: false

    - name: Log test 4 results
      ansible.builtin.lineinfile:
        path: "{{ results_dir }}/connectivity_test_{{ test_timestamp }}.log"
        line: "[TEST4] {{ item.item.0.group_name }}->{{ item.item.1.group_name }} WAN: {{ 'PASS' if item.rc == 0 else 'FAIL' }}"
      loop: "{{ test4.results }}"
      when: not item.skipped | default(false)

    # Test 5: Cross-student LAN
    - name: Ping cross-student LAN
      ansible.builtin.shell:
        cmd: "sshpass -p '{{ pfsense_pass }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ pfsense_user }}@{{ item.0.wan_ip }} 'ping -c 3 {{ item.1.lan_ip }}'"
      loop: "{{ student_groups | product(student_groups) | list }}"
      when: item.0.group_id != item.1.group_id
      register: test5
      ignore_errors: true
      changed_when: false

    - name: Log test 5 results
      ansible.builtin.lineinfile:
        path: "{{ results_dir }}/connectivity_test_{{ test_timestamp }}.log"
        line: "[TEST5] {{ item.item.0.group_name }}->{{ item.item.1.group_name }} LAN: {{ 'PASS' if item.rc == 0 else 'FAIL' }}"
      loop: "{{ test5.results }}"
      when: not item.skipped | default(false)

    # Test 6: Security Onion
    - name: Ping Security Onion
      ansible.builtin.shell:
        cmd: "sshpass -p '{{ pfsense_pass }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ pfsense_user }}@{{ instructor_wan }} 'ping -c 3 {{ so_ip }}'"
      register: test6
      ignore_errors: true
      changed_when: false

    - name: Log test 6 results
      ansible.builtin.lineinfile:
        path: "{{ results_dir }}/connectivity_test_{{ test_timestamp }}.log"
        line: "[TEST6] Instructor->SecurityOnion ({{ so_ip }}): {{ 'PASS' if test6.rc == 0 else 'FAIL' }}"

    # Summary
    - name: Calculate summary
      ansible.builtin.set_fact:
        t1_pass: "{{ test1.results | selectattr('rc', 'equalto', 0) | list | length }}"
        t1_total: "{{ test1.results | length }}"
        t2_pass: "{{ test2.results | selectattr('rc', 'equalto', 0) | list | length }}"
        t2_total: "{{ test2.results | length }}"
        t3_pass: "{{ test3.results | selectattr('rc', 'equalto', 0) | list | length }}"
        t3_total: "{{ test3.results | length }}"
        t4_pass: "{{ test4.results | rejectattr('skipped', 'defined') | selectattr('rc', 'equalto', 0) | list | length }}"
        t4_total: "{{ test4.results | rejectattr('skipped', 'defined') | list | length }}"
        t5_pass: "{{ test5.results | rejectattr('skipped', 'defined') | selectattr('rc', 'equalto', 0) | list | length }}"
        t5_total: "{{ test5.results | rejectattr('skipped', 'defined') | list | length }}"
        t6_pass: "{{ 1 if test6.rc == 0 else 0 }}"

    - name: Write summary to file
      ansible.builtin.lineinfile:
        path: "{{ results_dir }}/connectivity_test_{{ test_timestamp }}.log"
        line: |
          
          ========================================
          SUMMARY
          ========================================
          Instructor->Student WAN: {{ t1_pass }}/{{ t1_total }}
          Instructor->Student LAN: {{ t2_pass }}/{{ t2_total }}
          Student->Instructor: {{ t3_pass }}/{{ t3_total }}
          Cross-Student WAN: {{ t4_pass }}/{{ t4_total }}
          Cross-Student LAN: {{ t5_pass }}/{{ t5_total }}
          Security Onion: {{ t6_pass }}/1

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "CONNECTIVITY TEST RESULTS"
          - "========================================="
          - "Instructor->Student WAN: {{ t1_pass }}/{{ t1_total }}"
          - "Instructor->Student LAN: {{ t2_pass }}/{{ t2_total }}"
          - "Student->Instructor: {{ t3_pass }}/{{ t3_total }}"
          - "Cross-Student WAN: {{ t4_pass }}/{{ t4_total }}"
          - "Cross-Student LAN: {{ t5_pass }}/{{ t5_total }}"
          - "Security Onion: {{ t6_pass }}/1"
          - "========================================="
          - "Results: {{ results_dir }}/connectivity_test_{{ test_timestamp }}.log"