---
# ============================================================================
# Playbook: Convert pfSense Templates to VMs for Groups 3-15
# ============================================================================
# Purpose: Convert Proxmox templates back to VMs for student group pfSense gateways
#
# This playbook:
#   1. Loops through groups 3-15
#   2. Converts each pfSense template back to a VM
#
# Template IDs to Convert:
#   - Group 3: 8005
#   - Group 4: 8006
#   - ...
#   - Group 15: 8017
#
# Use Case: When you need to modify templates (change settings, update config, etc.)
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml \
#     stage2/tasks/network/convert_templates_to_vms.yml \
#     --ask-vault-pass
#
# Author: Emily Miller
# Last Updated: December 28, 2025
# ============================================================================

- name: Convert Student pfSense Templates to VMs for Groups 3-15
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
  - name: Display conversion notice
    ansible.builtin.debug:
      msg: |
        ========================================
        Converting pfSense Templates to VMs
        ========================================
        Templates to Convert: Groups 3-15 (13 total)
        Template IDs: 8005-8017
        These will become editable VMs
        ========================================

  - name: Pause for confirmation
    ansible.builtin.pause:
      prompt: "Press ENTER to continue with template conversion, or Ctrl+C to abort"

  # ========================================
  # Loop Through Groups 3-15
  # ========================================

  - name: Convert template to VM for Group {{ item }}
    ansible.builtin.command:
      cmd: >
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm set {{ 8002 + item }} --template 0"
    loop: "{{ range(3, 16) | list }}"
    register: convert_results
    changed_when: true
    failed_when: false

  - name: Display conversion results
    ansible.builtin.debug:
      msg: "{{ '✓' if item.rc == 0 else '✗' }} Group {{ item.item }} template {{ 'converted to VM' if item.rc == 0 else 'conversion failed' }} (VM {{ 8002 + item.item }})"
    loop: "{{ convert_results.results }}"
    loop_control:
      label: "Group {{ item.item }}"

  - name: Display batch conversion summary
    ansible.builtin.debug:
      msg: |
        ========================================
        ✓ Template Conversion Complete
        ========================================
        Converted: Groups 3-15 (13 total)
        VM IDs: 8005-8017
        These are now editable VMs, not templates

        To convert back to templates, run:
          ansible-playbook -i inventory/hosts.yml \
            stage2/tasks/network/convert_vms_to_templates.yml \
            --ask-vault-pass
        ========================================
