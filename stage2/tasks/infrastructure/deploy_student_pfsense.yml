---
# ============================================================================
# Playbook: Deploy Student pfSense with Serial Console Automation
# ============================================================================
# Purpose: Use serial console for expect automation (more reliable than qm terminal)
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml deploy_student_pfsense_serial.yml \
#     -e "group_id=2" --ask-vault-pass
#
# Requirements:
#   - pfSense template must have serial console enabled
#   - expect installed on Proxmox host
#
# Author: Emily Miller
# Last Updated: December 28, 2025
# ============================================================================

- name: Deploy Student pfSense with Serial Console Automation
  hosts: localhost
  gather_facts: false
  
  tasks:

  # ========================================
  # Calculate VM IDs and Bridges
  # ========================================

  - name: Convert group_id to integer
    ansible.builtin.set_fact:
      group_id: "{{ group_id | int }}"

  - name: Calculate VM IDs and bridges for Group {{ group_id }}
    ansible.builtin.set_fact:
      group_pfsense_id: "{{ (vm_ids.student_base | int) + (((group_id | int) - 1) * (vm_ids.student_block_size | int)) + 1 }}"
      group_wan_bridge: "vmbr255{{ '%03d' | format(group_id | int) }}"
      group_lan_bridge: "vmbr{{ '%03d' | format(group_id | int) }}000"

  - name: Display Student pfSense deployment notice for Group {{ group_id }}
    ansible.builtin.debug:
      msg: |
        ========================================
        Deploying Group {{ group_id }} pfSense (VM {{ group_pfsense_id }})
        ========================================
        Template: VM {{ templates.group1_pfsense_template_id }}
        Method: Serial console automation (expect)
        ========================================

  - name: Display calculated configuration
    ansible.builtin.debug:
      msg: |
        Group {{ group_id }} Configuration:
          VM ID: {{ group_pfsense_id }}
          WAN Bridge: {{ group_wan_bridge }}
          LAN Bridge: {{ group_lan_bridge }}

  # ========================================
  # Clone and Configure
  # ========================================

  - name: Clone Group {{ group_id }} pfSense from Group 1 template
    ansible.builtin.command:
      cmd: >
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
        "qm clone {{ templates.group1_pfsense_template_id }} {{ group_pfsense_id }}
        --name student-group{{ '%02d' | format(group_id | int) }}-pfsense --full"
    register: clone_result
    changed_when: true
    failed_when: clone_result.rc != 0

  - name: Assign WAN bridge
    ansible.builtin.command:
      cmd: >
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
        "qm set {{ group_pfsense_id }} --net0 virtio,bridge={{ group_wan_bridge }},firewall=1"
    changed_when: true

  - name: Assign LAN bridge
    ansible.builtin.command:
      cmd: >
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
        "qm set {{ group_pfsense_id }} --net1 virtio,bridge={{ group_lan_bridge }},firewall=1"
    changed_when: true

  # Enable serial console for automation
  - name: Enable serial console on VM
    ansible.builtin.command:
      cmd: >
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
        "qm set {{ group_pfsense_id }} --serial0 socket"
    changed_when: true

  - name: Start VM
    ansible.builtin.command:
      cmd: >
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
        "qm start {{ group_pfsense_id }}"
    changed_when: true

  - name: Wait for initial boot
    ansible.builtin.pause:
      seconds: 60
      prompt: "Waiting 60 seconds for pfSense to boot to setup wizard..."

  # ========================================
  # Create Expect Script for Serial Console
  # ========================================

  - name: Create expect script for serial console automation
    ansible.builtin.shell:
      cmd: |
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} 'cat > /tmp/pfsense_serial_{{ group_pfsense_id }}.exp << "EOFSCRIPT"
        #!/usr/bin/expect -f
        
        set timeout 300
        set vmid {{ group_pfsense_id }}
        
        log_user 1
        exp_internal 1
        
        puts "==== Connecting to VM serial console ===="
        spawn socat UNIX-CONNECT:/var/run/qemu-server/$vmid.serial0 STDIO
        
        puts "==== Waiting for VLAN prompt ===="
        expect {
          -re "VLANs.*set up now" {
            puts "==== Found VLAN prompt, sending n ===="
            sleep 2
            send "n\r"
          }
          timeout {
            puts "==== TIMEOUT waiting for VLAN prompt ===="
            exit 1
          }
        }
        
        puts "==== Waiting for WAN interface prompt ===="
        expect {
          -re "WAN interface" {
            puts "==== Found WAN prompt, sending vtnet0 ===="
            sleep 2
            send "vtnet0\r"
          }
          timeout {
            puts "==== TIMEOUT waiting for WAN prompt ===="
            exit 1
          }
        }
        
        puts "==== Waiting for LAN interface prompt ===="
        expect {
          -re "LAN interface" {
            puts "==== Found LAN prompt, sending vtnet1 ===="
            sleep 2
            send "vtnet1\r"
          }
          timeout {
            puts "==== TIMEOUT waiting for LAN prompt ===="
            exit 1
          }
        }
        
        puts "==== Waiting for Optional interface prompt ===="
        expect {
          -re "Optional" {
            puts "==== Found Optional prompt, skipping ===="
            sleep 2
            send "\r"
          }
          timeout {
            puts "==== TIMEOUT waiting for Optional (may not appear) ===="
          }
        }
        
        puts "==== Waiting for confirmation ===="
        expect {
          -re "proceed" {
            puts "==== Found confirmation, sending y ===="
            sleep 2
            send "y\r"
          }
          timeout {
            puts "==== TIMEOUT waiting for confirmation ===="
            exit 1
          }
        }
        
        puts "==== Waiting for completion ===="
        expect {
          -re "ENTER" {
            puts "==== Setup completed! ===="
            sleep 2
            send "\r"
          }
          timeout {
            puts "==== TIMEOUT waiting for completion ===="
            exit 1
          }
        }
        
        sleep 3
        puts "==== DONE ===="
        exit 0
        EOFSCRIPT
        chmod +x /tmp/pfsense_serial_{{ group_pfsense_id }}.exp'
    register: create_script
    changed_when: true

  # ========================================
  # Execute Expect Script
  # ========================================

  - name: Run expect script on serial console
    ansible.builtin.command:
      cmd: >
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
        "expect /tmp/pfsense_serial_{{ group_pfsense_id }}.exp"
    register: expect_result
    changed_when: true
    failed_when: false
    async: 360
    poll: 10

  - name: Display expect script output
    ansible.builtin.debug:
      msg: |
        Expect script output:
        {{ expect_result.stdout }}
        
        Errors (if any):
        {{ expect_result.stderr }}

  - name: Cleanup expect script
    ansible.builtin.command:
      cmd: >
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
        "rm -f /tmp/pfsense_serial_{{ group_pfsense_id }}.exp"
    changed_when: false
    failed_when: false

  # ========================================
  # Verify Completion
  # ========================================

  - name: Wait for pfSense to stabilize after wizard
    ansible.builtin.pause:
      seconds: 30
      prompt: "Waiting 30 seconds for pfSense to complete initialization..."

  - name: Verify VM is running
    ansible.builtin.command:
      cmd: >
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
        "qm status {{ group_pfsense_id }}"
    register: vm_status
    changed_when: false

  - name: Display deployment completion
    ansible.builtin.debug:
      msg: |
        ========================================
        âœ“ Group {{ group_id }} pfSense Deployment Complete
        ========================================
        VM ID: {{ group_pfsense_id }}
        Status: {{ vm_status.stdout }}
        WAN: {{ group_wan_bridge }} (vtnet0)
        LAN: {{ group_lan_bridge }} (vtnet1)
        
        Setup wizard: {{ 'Completed via automation' if expect_result.rc == 0 else 'Check console for status' }}
        ========================================
