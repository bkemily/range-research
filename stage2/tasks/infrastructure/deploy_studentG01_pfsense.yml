---
# ============================================================================
# Task: Deploy Group 1 pfSense from Template
# ============================================================================
# Purpose: Deploy Group 1 pfSense gateway from pre-configured template
#
# Called by: deploy_student_group.yml (when group_id == 1)
#
# This task file:
#   1. Clones Group 1 pfSense from its dedicated template
#   2. Starts the VM
#   3. Waits for pfSense to boot
#
# Template Requirements:
#   - Template VM must have all hardware pre-configured (memory, CPU, BIOS, etc.)
#   - Template VM must have network interfaces configured with correct bridges:
#       * net0: vmbr255001 (WAN to Instructor pfSense OPT1)
#       * net1: vmbr001000 (Group 1 LAN)
#   - pfSense setup wizard must be completed in template
#   - All pfSense configurations (interfaces, firewall rules, etc.) must be complete
#
# VM Configuration:
#   - VM ID: 211 (vm_ids.group1_pfsense)
#   - Template: Group 1 pfSense template VM
#   - Storage: raid-lvm
#
# Network Interfaces:
#   - net0: vmbr255001 (WAN to Instructor)
#   - net1: vmbr001000 (Group 1 LAN)
#
# Author: Emily Miller
# Last Updated: December 27, 2025
# ============================================================================

- name: Display Group 1 pfSense deployment notice
  ansible.builtin.debug:
    msg: |
      ========================================
      Deploying Group 1 pfSense (VM {{ group_pfsense_id }})
      ========================================
      Template: VM {{ templates.group1_pfsense_template_id }}
      Storage: {{ storage }}
      Networks (pre-configured in template):
        - net0: vmbr255001 (WAN to Instructor)
        - net1: vmbr001000 (Group 1 LAN)
      ========================================

# ========================================
# Clone from Template
# ========================================

- name: Display clone notice
  ansible.builtin.debug:
    msg: "Cloning VM {{ templates.group1_pfsense_template_id }} → VM {{ group_pfsense_id }}"

- name: Clone Group 1 pfSense from template
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
      "qm clone {{ templates.group1_pfsense_template_id }} {{ group_pfsense_id }}
      --name student-group01-pfsense --full"
  register: clone_result
  changed_when: true
  failed_when: clone_result.rc != 0

- name: Display clone status
  ansible.builtin.debug:
    msg: "✓ Group 1 pfSense cloned from template (VM {{ group_pfsense_id }})"

# ========================================
# Start VM
# ========================================

- name: Display VM start notice
  ansible.builtin.debug:
    msg: "Starting Group 1 pfSense VM {{ group_pfsense_id }}"

- name: Start Group 1 pfSense VM
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
      "qm start {{ group_pfsense_id }}"
  register: start_result
  changed_when: true
  failed_when: start_result.rc != 0

- name: Display VM start status
  ansible.builtin.debug:
    msg: "✓ Group 1 pfSense VM started (VM {{ group_pfsense_id }})"

# ========================================
# Wait for pfSense to Boot
# ========================================

- name: Wait for Group 1 pfSense to boot
  ansible.builtin.pause:
    seconds: "{{ automation.pfsense_boot_wait_seconds }}"
    prompt: "Waiting {{ automation.pfsense_boot_wait_seconds }} seconds for Group 1 pfSense to boot..."

- name: Verify VM is running
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
      "qm status {{ group_pfsense_id }}"
  register: vm_status
  changed_when: false
  failed_when: "'running' not in vm_status.stdout"

- name: Display deployment completion
  ansible.builtin.debug:
    msg: |
      ========================================
      ✓ Group 1 pfSense Deployment Complete
      ========================================
      Group: 1
      VM ID: {{ group_pfsense_id }}
      Status: {{ vm_status.stdout }}
      WAN: vmbr255001 (net0)
      LAN: vmbr001000 (net1)
      ========================================
