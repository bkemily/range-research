---
# ============================================================================
# Playbook: Create Group 3 pfSense Template
# ============================================================================
# Purpose: Create a Proxmox template for Group 3 pfSense gateway
#
# This playbook:
#   1. Clones Group 2 pfSense template as base
#   2. Updates network bridges for Group 3
#   3. Converts to template
#
# Template Configuration:
#   - Template ID: 9003 (templates.group3_pfsense_template_id)
#   - Base: Group 2 pfSense template (9002)
#   - Network Interfaces:
#       * net0: vmbr255003 (WAN to Instructor pfSense OPT3)
#       * net1: vmbr003000 (Group 3 LAN)
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml \
#     stage2/tasks/infrastructure/deploy_studentG03_pfsense.yml \
#     --ask-vault-pass
#
# Author: Emily Miller
# Last Updated: December 28, 2025
# ============================================================================

- name: Create Group 3 pfSense Template
  hosts: proxmox_host
  gather_facts: no
  
  tasks:
    - name: Display template creation notice
      ansible.builtin.debug:
        msg: |
          ========================================
          Creating Group 3 pfSense Template
          ========================================
          Base Template: VM {{ templates.group2_pfsense_template_id }}
          New Template ID: {{ templates.group3_pfsense_template_id }}
          Storage: {{ storage }}
          Networks:
            - net0: vmbr255003 (WAN to Instructor)
            - net1: vmbr003000 (Group 3 LAN)
          ========================================

    # ========================================
    # Clone from Group 2 Template
    # ========================================

    - name: Display clone notice
      ansible.builtin.debug:
        msg: "Cloning template {{ templates.group2_pfsense_template_id }} → {{ templates.group3_pfsense_template_id }}"

    - name: Clone Group 2 pfSense template
      ansible.builtin.command:
        cmd: >
          ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
          "qm clone {{ templates.group2_pfsense_template_id }} {{ templates.group3_pfsense_template_id }}
          --name pfsense-group03-template --full"
      register: clone_result
      changed_when: true
      failed_when: clone_result.rc != 0

    - name: Display clone status
      ansible.builtin.debug:
        msg: "✓ Template cloned (VM {{ templates.group3_pfsense_template_id }})"

    - name: Wait for clone operation to complete
      ansible.builtin.pause:
        seconds: 5

    # ========================================
    # Update Network Bridges
    # ========================================

    - name: Update WAN bridge (net0)
      ansible.builtin.command:
        cmd: >
          ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
          "qm set {{ templates.group3_pfsense_template_id }}
          --net0 virtio,bridge=vmbr255003"
      register: wan_result
      changed_when: true
      failed_when: wan_result.rc != 0

    - name: Display WAN bridge update
      ansible.builtin.debug:
        msg: "✓ WAN bridge updated to vmbr255003"

    - name: Update LAN bridge (net1)
      ansible.builtin.command:
        cmd: >
          ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
          "qm set {{ templates.group3_pfsense_template_id }}
          --net1 virtio,bridge=vmbr003000"
      register: lan_result
      changed_when: true
      failed_when: lan_result.rc != 0

    - name: Display LAN bridge update
      ansible.builtin.debug:
        msg: "✓ LAN bridge updated to vmbr003000"

    # ========================================
    # Convert to Template
    # ========================================

    - name: Convert VM to template
      ansible.builtin.command:
        cmd: >
          ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
          "qm template {{ templates.group3_pfsense_template_id }}"
      register: template_result
      changed_when: true
      failed_when: template_result.rc != 0

    - name: Display template creation completion
      ansible.builtin.debug:
        msg: |
          ========================================
          ✓ Group 3 pfSense Template Created
          ========================================
          Template ID: {{ templates.group3_pfsense_template_id }}
          WAN: vmbr255003 (net0)
          LAN: vmbr003000 (net1)
          Ready for deployment!
          ========================================