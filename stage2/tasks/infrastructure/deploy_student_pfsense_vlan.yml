# ============================================================================
# Task: Deploy Student pfSense (VLAN Template)
# ============================================================================
# Purpose: Deploy student pfSense by cloning from VLAN template
#
# Called by: deploy_student_group.yml
#
# This task simply clones from the VLAN template without any modifications.
# The template should already have the correct VLAN configuration.
#
# Required variables (from deploy_student_group.yml):
#   - group_id: Student group number
#   - group_pfsense_id: Calculated VM ID for this pfSense
#
# Author: Emily Miller
# Last Updated: December 30, 2025
# ============================================================================

- name: Display pfSense deployment for Group {{ group_id }}
  ansible.builtin.debug:
    msg: "Deploying Group {{ group_id }} pfSense (VM {{ group_pfsense_id }}) from VLAN template"

- name: Clone pfSense from VLAN template
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm clone {{ templates.vlan_student_pfsense_template_id }} {{ group_pfsense_id }} --name student-group{{ '%02d' | format(group_id) }}-pfsense --full"
  register: clone_result
  changed_when: true
  failed_when: clone_result.rc != 0

- name: Start pfSense VM
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm start {{ group_pfsense_id }}"
  register: start_result
  changed_when: true
  failed_when: start_result.rc != 0

- name: Display pfSense deployment completion
  ansible.builtin.debug:
    msg: "âœ“ Group {{ group_id }} pfSense deployed (VM {{ group_pfsense_id }})"
