---
# ============================================================================
# Task: Deploy Instructor pfSense
# ============================================================================
# Purpose: Deploy instructor pfSense gateway
#
# Called by: deploy_instructor_group.yml
#
# This task file:
#   1. Imports Instructor pfSense OVF from NFS storage
#   2. Configures VM hardware (memory, CPU, SCSI, BIOS, boot order)
#   3. Assigns network interfaces:
#      - net0: WAN (vmbr51)
#      - net1-net15: OPT interfaces to student group WANs (vmbr255001-vmbr255015)
#   4. Starts the VM
#   5. Waits for pfSense to boot
#
# VM Configuration:
#   - VM ID: 100 (vm_ids.instructor_pfsense)
#   - Template: TEMPLATE-pfsense-instructor.ovf
#   - Storage: raid-lvm
#   - Memory: 2048 MB
#   - CPU: 2 cores (1 socket)
#
# Network Interfaces (total: 1 + max_student_groups):
#   - net0: vmbr51 (WAN)
#   - net1-net15: vmbr255001-vmbr255015 (OPT1-OPT15 to student groups)
#
# NOTE: Instructor LAN (vmbr255000) is managed internally by pfSense configuration,
#       not assigned as a bridge to a VM network interface
#
# Author: Emily Miller
# Last Updated: December 14, 2025
# ============================================================================

- name: Display Instructor pfSense deployment notice
  ansible.builtin.debug:
    msg: |
      ========================================
      Deploying Instructor pfSense (VM {{ vm_ids.instructor_pfsense }})
      ========================================
      Template: {{ templates.pfsense_instructor }}
      Storage: {{ storage }}
      Networks:
        - net0: {{ bridges.instructor_wan }} (WAN)
        - net1-net{{ max_student_groups }}: Student group WANs ({{ max_student_groups }} groups)
      Total Interfaces: {{ 1 + max_student_groups }}

      NOTE: Instructor LAN ({{ bridges.instructor_lan }}) managed internally by pfSense
      ========================================

# ========================================
# Import OVF Template
# ========================================

- name: Import Instructor pfSense OVF
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm importovf {{ vm_ids.instructor_pfsense }} {{ templates.pfsense_instructor }} {{ storage }}"
  register: import_result
  changed_when: true
  failed_when: import_result.rc != 0

- name: Display import status
  ansible.builtin.debug:
    msg: "✓ Instructor pfSense OVF imported (VM {{ vm_ids.instructor_pfsense }})"

# ========================================
# Configure VM Resources (Memory & CPU)
# ========================================

- name: Configure memory and CPU
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm set {{ vm_ids.instructor_pfsense }} --memory {{ pfsense_resources.memory }} --cores {{ pfsense_resources.cores }} --sockets {{ pfsense_resources.sockets }}"
  register: resources_result
  changed_when: true
  failed_when: resources_result.rc != 0

- name: Display resource configuration status
  ansible.builtin.debug:
    msg: "✓ Memory: {{ pfsense_resources.memory }} MB, CPU: {{ pfsense_resources.cores }} cores ({{ pfsense_resources.sockets }} socket)"

# ========================================
# Configure VM Hardware
# ========================================

- name: Configure SCSI controller and disk
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm set {{ vm_ids.instructor_pfsense }} --scsihw virtio-scsi-pci --scsi0 {{ storage }}:vm-{{ vm_ids.instructor_pfsense }}-disk-0"
  register: scsi_result
  changed_when: true
  failed_when: scsi_result.rc != 0

- name: Display SCSI configuration status
  ansible.builtin.debug:
    msg: "✓ SCSI controller configured"

- name: Configure BIOS
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm set {{ vm_ids.instructor_pfsense }} --bios seabios"
  register: bios_result
  changed_when: true
  failed_when: bios_result.rc != 0

- name: Display BIOS configuration status
  ansible.builtin.debug:
    msg: "✓ BIOS set to SeaBIOS"

- name: Configure boot order
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm set {{ vm_ids.instructor_pfsense }} --boot order=scsi0"
  register: boot_result
  changed_when: true
  failed_when: boot_result.rc != 0

- name: Display boot order status
  ansible.builtin.debug:
    msg: "✓ Boot order configured (scsi0)"

# ========================================
# Configure Network Interfaces
# ========================================

- name: Assign WAN interface (net0)
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm set {{ vm_ids.instructor_pfsense }} --net0 virtio,bridge={{ bridges.instructor_wan }}"
  register: net0_result
  changed_when: true
  failed_when: net0_result.rc != 0

- name: Display WAN interface assignment
  ansible.builtin.debug:
    msg: "✓ net0 assigned: {{ bridges.instructor_wan }} (WAN)"

# ========================================
# Configure Student Group WAN Interfaces (OPT1-OPT15)
# ========================================
# Each student group gets an OPT interface on the instructor pfSense
# These connect instructor pfSense to each student group's pfSense WAN
#
# Interface mapping:
#   net1 = OPT1 = vmbr255001 (Group 1 WAN)
#   net2 = OPT2 = vmbr255002 (Group 2 WAN)
#   ...
#   net15 = OPT15 = vmbr255015 (Group 15 WAN)

- name: Generate student group WAN interface assignments
  ansible.builtin.set_fact:
    student_wan_interfaces: "{{ student_wan_interfaces | default([]) + [interface_config] }}"
  vars:
    net_id: "net{{ item }}" # net1, net2, ..., net15
    bridge: "vmbr255{{ '%03d' | format(item) }}" # vmbr255001, vmbr255002, ..., vmbr255015
    interface_config:
      net_id: "{{ net_id }}"
      bridge: "{{ bridge }}"
      group_id: "{{ item }}"
      description: "OPT{{ item }} - Group {{ item }} WAN"
  loop: "{{ range(1, max_student_groups + 1) | list }}"

- name: Display student WAN interfaces to assign
  ansible.builtin.debug:
    msg: "Assigning {{ max_student_groups }} student group WAN interfaces (net1-net{{ max_student_groups }})"

- name: Assign student group WAN interfaces
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm set {{ vm_ids.instructor_pfsense }} --{{ item.net_id }} virtio,bridge={{ item.bridge }}"
  loop: "{{ student_wan_interfaces }}"
  register: student_wan_result
  changed_when: true
  failed_when: student_wan_result.rc != 0

- name: Display student WAN interface assignments
  ansible.builtin.debug:
    msg: "✓ {{ item.net_id }} assigned: {{ item.bridge }} ({{ item.description }})"
  loop: "{{ student_wan_interfaces }}"

# ========================================
# Display Network Configuration Summary
# ========================================

- name: Display network configuration summary
  ansible.builtin.debug:
    msg: |
      ========================================
      Network Interfaces Configured
      ========================================
      Total: {{ 1 + max_student_groups }} interfaces

      WAN:
        - net0: {{ bridges.instructor_wan }} (WAN)

      Student Group WANs (OPT interfaces):
      {% for interface in student_wan_interfaces %}
        - {{ interface.net_id }}: {{ interface.bridge }} ({{ interface.description }})
      {% endfor %}

      NOTE: Instructor LAN ({{ bridges.instructor_lan }}) managed internally by pfSense
      ========================================

# ========================================
# Start VM
# ========================================

- name: Start Instructor pfSense VM
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm start {{ vm_ids.instructor_pfsense }}"
  register: start_result
  changed_when: true
  failed_when: start_result.rc != 0

- name: Display VM start status
  ansible.builtin.debug:
    msg: "✓ Instructor pfSense VM started (VM {{ vm_ids.instructor_pfsense }})"

# ========================================
# Wait for pfSense to Boot
# ========================================

- name: Wait for Instructor pfSense to boot
  ansible.builtin.pause:
    seconds: "{{ automation.pfsense_boot_wait_seconds }}"
    prompt: "Waiting {{ automation.pfsense_boot_wait_seconds }} seconds for Instructor pfSense to boot..."

- name: Verify VM is running
  ansible.builtin.command:
    cmd: >
      ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }} "qm status {{ vm_ids.instructor_pfsense }}"
  register: vm_status
  changed_when: false
  failed_when: "'running' not in vm_status.stdout"

- name: Display deployment completion
  ansible.builtin.debug:
    msg: |
      ========================================
      ✓ Instructor pfSense Deployment Complete
      ========================================
      VM ID: {{ vm_ids.instructor_pfsense }}
      Status: {{ vm_status.stdout }}
      Total Interfaces: {{ 1 + max_student_groups }}
      WAN: {{ bridges.instructor_wan }}
      OPT Interfaces: net1-net{{ max_student_groups }}
      ========================================
