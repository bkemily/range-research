---
# ============================================================================
# Phase 2.2: Configure Network
# ============================================================================
# Purpose: Configure pfSense routing and firewall rules
#
# Called by: run_full_campaign.yml
#
# This playbook:
#   1. Configures Spark pfSense
#   2. Configures Instructor pfSense
#   3. Configures Student pfSense instances (loops for each group)
#   4. Verifies network connectivity
#
# Author: Emily Miller
# Last Updated: December 15, 2025
# ============================================================================

- name: Phase 2.2 - Configure Network
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    pfsense_default_user: "admin"
    pfsense_default_password: "pfsense"

  tasks:
  # ========================================
  # Initialize pfSense Consoles (First Boot)
  # ========================================

  - name: Display console initialization notice
    ansible.builtin.debug:
      msg: |
        ========================================
        Initializing pfSense Consoles
        ========================================
        Automating interface assignment for all pfSense VMs
        This will take approximately 2-3 minutes per pfSense
        ========================================

  - name: Initialize Instructor pfSense
    ansible.builtin.include_tasks: tasks/network/initialize_pfsense_console.yml
    vars:
      vm_name: "Instructor pfSense"
      pfsense_vm_id: "{{ vm_ids.instructor_pfsense }}"

  - name: Initialize Student pfSense VMs
    ansible.builtin.include_tasks: tasks/network/initialize_pfsense_console.yml
    loop: "{{ range(1, max_student_groups + 1) | list }}"
    loop_control:
      loop_var: group_id
      label: "Group {{ group_id }}"
    vars:
      vm_name: "Student Group {{ group_id }} pfSense"
      pfsense_vm_id: "{{ vm_ids.student_base + ((group_id - 1) * vm_ids.student_block_size) + 1 }}"

  - name: Display initialization completion
    ansible.builtin.debug:
      msg: |
        ========================================
        ✓ All pfSense VMs Initialized
        ========================================
        pfSense instances now have interfaces assigned
        Default LAN IPs: 192.168.1.1
        Ready for XML configuration
        ========================================
        
  # ========================================
  # Configure Spark pfSense
  # ========================================

  - name: Display Spark pfSense configuration notice
    ansible.builtin.debug:
      msg: |
        ========================================
        Configuring Spark pfSense
        ========================================

  #- name: Configure Spark pfSense
    #ansible.builtin.include_tasks: tasks/network/configure_pfsense.yml
    #vars:
      #vm_name: "Spark pfSense"
      #pfsense_ip: "192.168.68.50" # Temporary IP on management network
      #pfsense_user: "{{ pfsense_default_user }}"
      #pfsense_password: "{{ pfsense_default_password }}"
      #config_file: "{{ playbook_dir }}/pfsense_configs/spark-config.xml"

  # ========================================
  # Configure Instructor pfSense
  # ========================================

  # Configure Instructor pfSense
  - name: Configure Instructor pfSense
    ansible.builtin.include_tasks: tasks/network/configure_pfsense.yml
    vars:
      vm_name: "Instructor pfSense"
      group_number: "0"  # Or whatever number instructor should use

  # ========================================
  # Configure Student pfSense Instances
  # ========================================

  - name: Display Student pfSense configuration notice
    ansible.builtin.debug:
      msg: |
        ========================================
        Configuring {{ max_student_groups }} Student pfSense Instances
        ========================================

  - name: Generate Student pfSense configuration from template
    ansible.builtin.template:
      src: "{{ playbook_dir }}/pfsense_configs/student-group.xml.j2"
      dest: "{{ playbook_dir }}/pfsense_configs/generated/student-group-{{ '%02d' | format(item) }}.xml"
    loop: "{{ range(1, max_student_groups + 1) | list }}"
    vars:
      group_id: "{{ item }}"

  # Configure Student pfSense instances
  - name: Configure Student pfSense instances
    ansible.builtin.include_tasks: tasks/network/configure_pfsense.yml
    loop: "{{ range(1, max_student_groups + 1) | list }}"
    loop_control:
      loop_var: group_id
      label: "Group {{ group_id }}"
    vars:
      vm_name: "Student Group {{ group_id }} pfSense"
      group_number: "{{ group_id }}"  # Just the number: 1, 2, 3, etc.

  # ========================================
  # Verify Network Connectivity
  # ========================================

  - name: Display network verification notice
    ansible.builtin.debug:
      msg: |
        ========================================
        Verifying Network Connectivity
        ========================================

  - name: Verify connectivity
    ansible.builtin.include_tasks: tasks/network/verify_network_connectivity.yml

  - name: Display Phase 2.2 completion
    ansible.builtin.debug:
      msg: |
        ========================================
        ✓ Phase 2.2 Complete
        ========================================
        Network configuration applied to all pfSense instances
        ========================================

  # ========================================
  # Start Client VMs Now That pfSense is Configured
  # ========================================
  
  - name: Display client VM startup notice
    ansible.builtin.debug:
      msg: |
        ========================================
        Starting Client VMs
        ========================================
        pfSense is now configured. Starting all client VMs...
        
        Infrastructure:
          - Instructor Kali (VM {{ vm_ids.instructor_kali }})
        
        Student Groups ({{ max_student_groups }} groups):
          - 2x Kali per group
          - 2x MS3 (Ubuntu + Windows) per group
        
        Total client VMs: {{ 1 + (max_student_groups * 4) }}
        ========================================

  # Start Instructor Kali
  - name: Start Instructor Kali
    ansible.builtin.command:
      cmd: >
        ssh {{ ssh.common_args }} {{ proxmox_user }}@{{ proxmox_host }}
        "qm start {{ vm_ids.instructor_kali }}"
    register: start_instructor_kali
    changed_when: true
    failed_when: start_instructor_kali.rc != 0

  - name: Display Instructor Kali start status
    ansible.builtin.debug:
      msg: "✓ Instructor Kali started (VM {{ vm_ids.instructor_kali }})"

  # Start Student Group Client VMs
  - name: Start Student Group {{ group_id }} Client VMs
    ansible.builtin.include_tasks: tasks/infrastructure/start_student_group_vms.yml
    loop: "{{ range(1, max_student_groups + 1) | list }}"
    loop_control:
      loop_var: group_id
      label: "Group {{ group_id }}"

  - name: Wait for client VMs to boot and acquire DHCP
    ansible.builtin.pause:
      seconds: 90
      prompt: "Waiting 90 seconds for client VMs to boot and receive DHCP leases from pfSense..."

  - name: Display client VM startup completion
    ansible.builtin.debug:
      msg: |
        ========================================
        ✓ All Client VMs Started
        ========================================
        Total VMs started: {{ 1 + (max_student_groups * 4) }}
        
        Client VMs are now booting and receiving DHCP from configured pfSense.
        
        Expected IPs:
          - Instructor Kali: 143.88.255.10
          - Group X Kali 1: 143.88.X.10
          - Group X Kali 2: 143.88.X.11
          - Group X MS3 Ubuntu: 143.88.X.13
          - Group X MS3 Windows: 143.88.X.14
        ========================================
