---
- name: Stage 0 - Configure Proxmox Network Bridges
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    proxmox_host: "192.168.68.89"
    proxmox_user: "root"
    interfaces_file: "/etc/network/interfaces"
    interfaces_backup: "/etc/network/interfaces.bak.{{ ansible_date_time.epoch }}"
    
    # Physical interface
    physical_interface: "ens3f0np0"
    
    # Management configuration
    management_ip: "192.168.68.89"
    management_netmask: "24"
    management_gateway: "192.168.68.1"
    
    # Number of student groups
    max_student_groups: 2
  
  tasks:
    - name: Display stage information
      ansible.builtin.debug:
        msg: |
          ========================================
          STAGE 0: Proxmox Network Configuration
          ========================================
          This playbook will:
            1. Backup /etc/network/interfaces
            2. Create new configuration with all bridges
            3. Reload network configuration
          
          Bridges to create:
            Infrastructure:
              - vmbr0 (Management, VLAN-aware)
              - vmbr0.68 (Management VLAN)
              - vmbr50 (Internet)
              - vmbr51 (Closed network, VLAN-aware)
            
            Instructor:
              - vmbr255000 (Instructor LAN)
            
            Student Groups ({{ max_student_groups }} groups):
              - vmbr255001, vmbr001000 (Group 1 WAN/LAN)
              - vmbr255002, vmbr002000 (Group 2 WAN/LAN)
          ========================================
    
    - name: Test SSH connection to Proxmox
      ansible.builtin.command: ssh -o ConnectTimeout=5 {{ proxmox_user }}@{{ proxmox_host }} "echo 'Connection successful'"
      register: ssh_test
      changed_when: false
      failed_when: ssh_test.rc != 0
    
    - name: Display connection status
      ansible.builtin.debug:
        msg: "✓ SSH connection to Proxmox successful"
    
    - name: Backup current interfaces file with timestamp
      ansible.builtin.command: ssh {{ proxmox_user }}@{{ proxmox_host }} "cp {{ interfaces_file }} {{ interfaces_backup }}"
      register: backup_result
      changed_when: true
    
    - name: Verify backup was created
      ansible.builtin.command: ssh {{ proxmox_user }}@{{ proxmox_host }} "test -f {{ interfaces_backup }}"
      changed_when: false
    
    - name: Display backup confirmation
      ansible.builtin.debug:
        msg: "✓ Backup created: {{ interfaces_backup }}"
    
    - name: Generate new network interfaces configuration
      ansible.builtin.set_fact:
        new_interfaces_config: |
          # Network configuration for Proxmox VE
          # Generated by Ansible Stage 0 on {{ ansible_date_time.iso8601 }}
          # Backup saved to: {{ interfaces_backup }}
          
          auto lo
          iface lo inet loopback
          
          iface {{ physical_interface }} inet manual
          
          auto vmbr0
          iface vmbr0 inet manual
              bridge-ports {{ physical_interface }}
              bridge-stp off
              bridge-fd 0
              bridge-vlan-aware yes
              bridge-vids 2-4094
          
          auto vmbr0.68
          iface vmbr0.68 inet static
              address {{ management_ip }}/{{ management_netmask }}
              gateway {{ management_gateway }}
              #vlan-raw-device vmbr0
          
          #internet
          auto vmbr50
          iface vmbr50 inet static
              bridge-ports none
              bridge-stp off
              bridge-fd 0
          
          #closed network
          auto vmbr51
          iface vmbr51 inet static
              bridge-ports none
              bridge-stp off
              bridge-fd 0
              bridge-vlan-aware yes
              bridge-vids 2-4094
          
          #instructor LAN
          auto vmbr255000
          iface vmbr255000 inet static
              bridge-ports none
              bridge-stp off
              bridge-fd 0
          
          # ========================================
          # Student Group Bridges
          # ========================================
          {% for group in range(1, max_student_groups + 1) %}
          
          # Group {{ group }} WAN (Instructor <-> Student)
          auto vmbr255{{ '%03d' | format(group) }}
          iface vmbr255{{ '%03d' | format(group) }} inet static
              bridge-ports none
              bridge-stp off
              bridge-fd 0
          
          # Group {{ group }} LAN
          auto vmbr{{ '%03d' | format(group) }}000
          iface vmbr{{ '%03d' | format(group) }}000 inet static
              bridge-ports none
              bridge-stp off
              bridge-fd 0
          {% endfor %}
    
    - name: Display generated configuration preview
      ansible.builtin.debug:
        msg: "{{ new_interfaces_config.split('\n')[:30] }}"
    
    - name: Write new configuration to temporary file
      ansible.builtin.copy:
        content: "{{ new_interfaces_config }}"
        dest: "/tmp/interfaces.new"
        mode: '0644'
      delegate_to: localhost
    
    - name: Copy new configuration to Proxmox
      ansible.builtin.command: scp /tmp/interfaces.new {{ proxmox_user }}@{{ proxmox_host }}:/tmp/interfaces.new
      changed_when: true
    
    - name: Display validation notice
      ansible.builtin.debug:
        msg: |
          ⚠️  Skipping dry-run validation (ifreload -i not supported)
          The configuration will be applied directly with backup protection.
    
    - name: Show what will be added
      ansible.builtin.debug:
        msg: |
          New bridges that will be created:
          {% for group in range(1, max_student_groups + 1) %}
            - vmbr255{{ '%03d' | format(group) }}: Group {{ group }} WAN
            - vmbr{{ '%03d' | format(group) }}000: Group {{ group }} LAN
          {% endfor %}
    
    - name: Confirm before applying changes
      ansible.builtin.pause:
        prompt: |
          
          ========================================
          Ready to apply network configuration
          ========================================
          
          This will:
          1. Overwrite {{ interfaces_file }}
          2. Reload network configuration
          3. Create all required bridges
          
          Backup saved to: {{ interfaces_backup }}
          
          Press ENTER to continue or Ctrl+C to abort
    
    - name: Apply new interfaces configuration
      ansible.builtin.command: ssh {{ proxmox_user }}@{{ proxmox_host }} "cp /tmp/interfaces.new {{ interfaces_file }}"
      register: interfaces_updated
      changed_when: true
    
    - name: Reload network configuration
      ansible.builtin.command: ssh {{ proxmox_user }}@{{ proxmox_host }} "ifreload -a"
      when: interfaces_updated.changed
      register: reload_result
    
    - name: Wait for network to stabilize
      ansible.builtin.pause:
        seconds: 10
      when: interfaces_updated.changed
    
    - name: Verify Proxmox is still accessible
      ansible.builtin.command: ssh {{ proxmox_user }}@{{ proxmox_host }} "echo 'Network reload successful'"
      register: connectivity_check
      retries: 5
      delay: 3
      until: connectivity_check.rc == 0
    
    - name: Get list of active bridges
      ansible.builtin.command: ssh {{ proxmox_user }}@{{ proxmox_host }} "ip link show | grep -oE 'vmbr[0-9.]+' | sort -u"
      register: active_bridges
      changed_when: false
    
    - name: Verify required bridges exist
      ansible.builtin.command: ssh {{ proxmox_user }}@{{ proxmox_host }} "ip link show {{ item }}"
      loop:
        - vmbr0
        - vmbr0.68
        - vmbr50
        - vmbr51
        - vmbr255000
        - vmbr255001
        - vmbr001000
        - vmbr255002
        - vmbr002000
      register: bridge_verification
      failed_when: bridge_verification.rc != 0
      changed_when: false
    
    - name: Clean up temporary file on Proxmox
      ansible.builtin.command: ssh {{ proxmox_user }}@{{ proxmox_host }} "rm -f /tmp/interfaces.new"
      changed_when: false
    
    - name: Clean up temporary file locally
      ansible.builtin.file:
        path: "/tmp/interfaces.new"
        state: absent
    
    - name: Display completion summary
      ansible.builtin.debug:
        msg: |
          ========================================
          Stage 0: Network Configuration Complete
          ========================================
          
          Active bridges:
          {{ active_bridges.stdout_lines | join('\n') }}
          
          Backup location: {{ interfaces_backup }}
          
          Configuration file: {{ interfaces_file }}
          
          Bridge naming schema:
            - vmbr255000: Instructor LAN
            - vmbr255GGG: Instructor <-> Group GGG WAN
            - vmbrGGG000: Group GGG LAN
          
          Next step: Run Stage 1 bootstrap
            cd ../stage1
            ansible-playbook -i ../inventory/hosts.yml stage1_bootstrap_security_onion.yml
          ========================================